working 3.9.2d
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>‚ùÑÔ∏è A/C Triage Pro v3.9.3 Working beta</title>
  <style>
label {
  font-weight: bold !important;
}

#advancedFieldsWrapper {
  display: none;
}

#factoryCharge {
  min-width: 80%; /* Adjust as needed for your longest option */
  width: auto;
  font-size: 1em;
}

input, select, textarea {
  width: 100%;
  min-width: 0;
  box-sizing: border-box;
  font-size: 1em;
}

@media (min-width: 700px) {
  select, input[type="number"], input[type="text"] {
    min-width: 180px;    /* Adjust input text to fit your longest label/option */
    max-width: 100%;
    font-size: .8em;
  }
  /* Optional: make Unit/short fields narrower */
  .short-field {
    min-width: 50px;
    max-width: 80px;
    width: auto;
  }
}

    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      color: #111;
      max-width: 800px;
      margin: auto;
      padding: 0px;
    }
    h2 { color: #0074D9; margin-bottom: 8px; }
.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 12px;
}

label {
  font-size: 0.85em;     /* Keeps label subtle */
  font-weight: 600;      /* Still readable */
  margin-bottom: 4px;
}
    label {
      display: block;
      margin-bottom: 3px;
      font-size: .90em;
    }
    input, select, textarea {
      width: 100%;
      font-size: 1em;
      padding: 8px;
      box-sizing: border-box;
      margin-bottom: 0;
    }
    /* flash animation */
    @keyframes flashBorder {
      0%, 100% { box-shadow: 0 0 0 3px rgba(255,0,0,0.9); }
      50%     { box-shadow: 0 0 0 3px rgba(255,0,0,0); }
    }
    .flash-refrig {
      animation: flashBorder 1s ease-in-out 3;
    }

    textarea { resize: vertical; }
    small { display: block; margin-top: 2px; }
    .button-group { display: flex; gap: 10px; margin-top: 16px; }
    button, .button-group button {
      background: #0074D9;
      color: #fff;
      border: none;
      padding: 10px 0;
      border-radius: 6px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: background 0.15s;
      margin-top: 0;
    }
    button.confirm { background: #2ECC40; }
    button.no, .modal-content button.no { background: #FF4136; }
    button.yes, .modal-content button.yes { background: #2ECC40; }
    #brandingHeader img { max-height: 36px; }
  
  /* Modal Styling */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 10px;
      max-width: 90vw;
      width: 500px;
      text-align: left;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .modal-content button { margin-top: 10px; }
    @media (max-width: 700px) {
      body { max-width: 100vw; padding: 10px; }
      .form-row { flex-direction: column; gap: 0; margin-bottom: 8px; }
      .form-cell { width: 100%; margin-bottom: 6px; }
      .modal-content { width: 96vw; padding: 10px; }
      button, .button-group button { font-size: 1em; padding: 10px 0; }
      #brandingHeader img { max-height: 32px; }
    }
    .report-section { margin: 12px 0; padding: 12px; background: #fafcff; border-radius: 8px; }
  
  .metric-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}
    .metric-bar { flex: 1; min-width: 160px; background: #eee; border-radius: 8px; padding: 6px 0; text-align: center; }
    footer { font-size: 0.85em; color: #666; text-align: center; margin-top: 40px; }

.cw_messages {
  margin-bottom: 10px;
  padding: 6px 10px;
  border-radius: 6px;
  background: #f4f8fa;
}

.bar-wrapper {
  width: 90%;
  margin: 8px auto 0 auto;
  height: 20px;
  background: #ddd;
  border-radius: 12px;
  position: relative;
  overflow: hidden;
}
.bar-track {
  width: 100%;
  height: 100%;
  position: relative;
  background: transparent;
}
.bar-fill {
  height: 100%;
  border-radius: 12px;
  position: absolute;
  left: 0;
  top: 0;
}
.bar-target {
  position: absolute;
  top: 0;
  height: 100%;
  background: rgba(46,204,64,0.2); /* light green band for target range */
  border-radius: 12px;
  z-index: 2;
}
.metric-label {
  font-size: 1em;
  margin-bottom: 3px;
  text-align: left;
  padding-left: 10px;
}
.metric-range {
  font-size: 0.88em;
  color: #555;
}
/* 1) the outer widget */
#chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  font-family: sans-serif;
}

/* 2) the round toggle icon */
#chat-widget #chat-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #0074D9 url('chat-icon.svg') center/60% no-repeat;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  cursor: pointer;
}

/* 3) chat box ‚Äî hidden by default */
#chat-widget .chat-container {
  display: none;
  position: fixed;       /* so it lives above the icon */
  bottom: 80px;          /* icon height (48px) + 20px margin + 12px extra */
  right: 20px;
  width: 360px;
  background: red;       /* your example color */
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  flex-direction: column;
  overflow: hidden;
  font-size: 0.95rem;
  max-height: 450px;
}

/* 4) when .open is toggled, show it */
#chat-widget.open .chat-container {
  display: flex;
}

    .chat-header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      font-weight: bold;
    }

    .chat-log {
      flex: 1;
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
    }

    .chat-log p {
      margin: 0.5rem 0;
    }

    .user-message {
      text-align: right;
      color: #2c3e50;
    }

    .bot-message {
      text-align: left;
      color: #444;
      white-space: pre-wrap;
      margin-bottom: 1rem;
    }

    .chat-input {
      display: flex;
      border-top: 1px solid #ccc;
    }

    .chat-input input {
      flex: 1;
      border: none;
      padding: 0.75rem;
      font-size: 1rem;
    }

    .chat-input button {
      border: none;
      background: #2c3e50;
      color: white;
      padding: 0.75rem 1rem;
      cursor: pointer;
    }

    .footer {
      text-align: center;
      font-size: 0.8rem;
      color: #aaa;
      padding: 0.5rem;
    }

  /* Tooltip container, relative so the popup can position itself */
  .tooltip {
    position: relative;
    cursor: pointer;
  }

  /* Hidden by default */
  .tooltip-content {
    display: none;
    position: absolute;
    top: -8px;            /* slightly above the bar */
    left: 50%;
    transform: translateX(-50%) translateY(-100%);
    background: #fff;
    border: 1px solid #ccc;
    padding: 8px;
    border-radius: 4px;
    width: 240px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 10;
    font-size: 0.9em;
    text-align: left;
  }

  /* When the container has .show, we reveal it */
  .tooltip.show .tooltip-content {
    display: block;
  }
</style>


  <!-- html2canvas, jspdf, html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <!-- HELP POPUP -->
  <div id="helpPopup" class="modal">
    <div class="modal-content">
      <h3>üöÄ Getting Started ‚Äì Diagnostic Triage Guide</h3>
      <ol style="text-align: left; font-size: 0.95em;">
        <li><strong>RO# / Customer / VIN:</strong> Enter basic job identifiers. VIN auto-fills the Year-Make-Model. <em>(Note: You can edit the Customer and the YMM fields.)</em></li><br>
        <li><strong>ZIP Code:</strong> Pulls local weather data to prefill ambient and RH fields. <br><em>Tip: If the ambient value doesn't reflect your actual shop conditions, feel free to manually overwrite it.</em></li><br>
        <li><strong>Static Pressure:</strong> Engine OFF ‚Äì Must open hood and allow system to acclimate (~10‚Äì20 min). Install low-side gauge and enter measured PSI. <br><em>The tool uses ambient temperature to calculate the expected static-pressure range.</em></li><br>
        <li><strong>Evaluate Fill State:</strong> If static PSI is within spec, the system likely has adequate refrigerant.</li>
        <ul style="margin-top: 6px; margin-left: 1em;">
          <li><strong>If in Range:</strong> Enter the factory-charge spec and continue to dynamic testing.</li>
          <li><strong>If Out of Range:</strong> Pause! Print report and recommend recover & recharge before further diagnostic to avoid chasing symptoms.</li>
        </ul>
      </ol>
      <button onclick="hideModal('helpPopup')">Close</button>
    </div>
  </div>

<!-- Accountability Modal: Tech Name Confirmation BEFORE static test -->
<div id="confirmationModal" class="modal">
  <div class="modal-content" style="max-width:420px;">
<h3>‚ö†Ô∏è Technician Confirmation ‚Äì EPA Section 609</h3>
  <ul style="font-size: 0.98em; margin-bottom: 14px;">
    <li><b>Federal law</b> requires Section 609 Certification to recover or service automotive A/C refrigerant.</li>
    <li><b>ALWAYS</b> verify the Refrigerant Type and System Label before connecting any recovery or recharge machine.</li>
    <li>Use a <b>quality manifold gauge set</b> and <b>calibrated thermometer</b> to confirm static pressure.</li>
    <li><b>Do NOT proceed</b> unless refrigerant type and static pressure are both correct for this system.</li>
    <li><b>Warning:</b> Recovering or charging a system with contaminated or incorrect refrigerant (such as R-134a in an R-1234yf system) can <b>permanently damage your equipment</b>.</li>
  </ul>
    <div style="margin-top:12px;">
      <label for="techNameInput" style="display:block;margin-bottom:6px;font-size:0.98em;">
        Technician Name (required for confirmation):
      </label>
      <input type="text" id="techNameInput" autocomplete="off" placeholder="Enter your name here‚Ä¶" />
    </div>
    <button id="confirmationContinueBtn" disabled style="margin-top:14px;">Continue</button>
  </div>
</div>


  <!-- TEST POINT POPUP -->
  <div id="testPointPopup" class="modal">
    <div class="modal-content">
      <h3>üìç Understanding Temperature Testing Points</h3>
      <ul style="font-size: 0.95em; line-height: 1.5;">
        <li><strong>üîµ TP #1 ‚Äì Suction Line (Evaporator Outlet):</strong><br>
          Place your temp sensor on the suction line just before the compressor. <br>
          <em>Used to calculate superheat and measure how much heat the refrigerant absorbed inside the evaporator.</em>
        </li><br>
        <li><strong>üü† TP #2 ‚Äì TXV Inlet (Liquid Line):</strong><br>
          Place your temp sensor on the liquid line right before the TXV. <br>
          <em>Helps detect heat gain, routing issues, or ambient heat soak before refrigerant expands.</em>
        </li><br>
        <li><strong>üî¥ TP #3 ‚Äì Condenser Outlet:</strong><br>
          Place your temp sensor on the liquid line coming out of the condenser. <br>
          <em>Used for subcooling analysis to confirm proper refrigerant condensation.</em>
        </li>
      </ul>
      <p style="font-size: 0.9em;"><strong>Tip:</strong> Use all three points for complete thermal-loop validation and to catch blind spots like liquid-line heat gain or TXV imbalance.</p>
      <button onclick="hideModal('testPointPopup')">Close</button>
    </div>
  </div>

  <!-- BRANDING MODAL -->
  <div id="brandingModal" class="modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <h3>Setup Your Shop Branding</h3>
      <label>Shop Name:</label>
      <input type="text" id="shopNameInput" placeholder="e.g. Joe‚Äôs Auto A/C" />
      <label>Upload Logo (optional):</label>
      <input type="file" id="shopLogoInput" accept="image/*" />
      <label>Contact Info (optional):</label>
      <textarea id="shopContactInput" rows="2" placeholder="Phone, email, or address‚Ä¶"></textarea>
      <button class="confirm" onclick="saveBranding()">Save Branding</button>

    </div>
  </div>

<!-- BRANDING HEADER -->
<style>
  #changeBrandingBtn {
    float: left;
    margin-bottom: 6px;
    padding: 4px 10px;
    font-size: 0.7em;
    text-align: left;
    width: auto;
    background-color: transparent;
    border: 1px solid #ccc;
    cursor: pointer;
    transition: color 0.2s ease, font-weight 0.2s ease;
  }

  #changeBrandingBtn:hover {
    color: #0000cc;
    font-weight: bold;
    text-decoration: underline;
  }

  #changeBrandingBtn:active {
    color: #004e99;
    font-style: italic;
  }
</style>

<div id="brandingHeader" style="margin-bottom: 10px; font-size: 0.9em;"></div>

<button id="changeBrandingBtn">
  <em>Change Branding</em>
</button>


<div style="text-align: center; margin-top: 12px;">

  <h2>‚ùÑÔ∏èA/C Triage</h2>
  <em>by Autotech Intelligence</em>
</div>

<button id="helpBtn" class="confirm" style="font-size: 0.8em; padding: 4px 8px; margin-bottom: 12px;">
 Read instruction on How to Start ü§î
</button>

<div id="reportTechName" style="font-weight: bold; margin: 1em 0 0.5em 0;"></div>


  <!-- FORM FIELDS -->
  <div class="form-row">
    <div class="form-cell">
      <label for="ro">RO#:</label>
      <input type="text" id="ro" placeholder="Enter RO#" />
    </div>
    <div class="form-cell">
      <label for="customer">Customer Name:</label>
      <input type="text" id="customer" placeholder="Enter Customer‚Äôs Name" />
    </div>
  </div>

  <div class="form-row">
    <div class="form-cell">
      <label for="vin">VIN (17 chars optional):</label>
      <input type="text" id="vin" maxlength="17" placeholder="Enter VIN" oninput="fetchVehicleData();" />
    </div>
    <div class="form-cell">
      <label for="vehicle">Year-Make-Model:</label>
<input type="text" id="vehicle" placeholder="Vehicle‚Äôs Year Make Model" oninput="this.value = this.value.toUpperCase(); 
autoToggleIHXFromVIN();"/> 

    </div>
  </div>

  <div id="timestamp" style="margin: 8px 0; font-weight: bold;"></div>
  <!-- REFRIGERANT TYPE -->

    <div class="form-cell" style="flex: 0 0 200px;">
      <label for="refrigerant">Refrigerant Type:</label>
      <select id="refrigerant">
        <option value="r134a">R-134a</option>
        <option value="r1234yf">R-1234yf</option>
      </select>
    </div>
  </div>

    <div class="form-cell">
      <label for="zipCode" style="font-size: 0.9em;">‚õÖÔ∏è ZIP Code (for weather):</label>
      <input type="text" id="zipCode" maxlength="5" placeholder="e.g. 77001" style="width: 20%;" />
      <small id="weatherStatus" style="color: blue;"></small>
    </div>


  <!-- AMBIENT & RH -->
 
    <div class="form-cell" style="flex: 0 0 120px;">
      <label for="ambient">Ambient Temp (¬∞F):</label>
      <input type="number" id="ambient" min="30" max="120" placeholder="e.g. 85" />
    </div>
    <div class="form-cell" style="display: none;">
      <label for="rh">Humidity (%):</label>
      <input type="number" id="rh" min="0" max="100" placeholder="e.g. 45" />
    </div>


  <!-- STATIC PRESSURE -->
  <div style="margin-bottom: 8px; font-size: 0.95em; color: blue;">
    <div id="staticPressureRangeDisplay">
       ü´ß Expected Static Pressure (Engine Off): <em>Enter ambient temperature</em>
    </div>
  </div>

    <div class="form-cell" style="flex: 0 0 240px;">
      <label for="staticPressure">Static Pressure (PSI):</label>
      <input type="number" id="staticPressure" placeholder="e.g. 85" />
      <em style="font-size: 0.85em; color: #555;">Tip: Install low-side gauge on service port before measuring.</em>
    </div>
  
  <!-- SERVICE PROMPT -->
  <div id="servicePrompt" style="margin-top: 16px;">
    <label for="serviceInterval"><strong>How long since last A/C service?</strong></label>
    <select id="serviceInterval">
      <option value="" disabled selected>Select one‚Ä¶</option>
      <option value="Never">Never</option>
      <option value="Recently">Recently</option>
      <option value="LastYear">Last Year</option>
      <option value="Unknown">Unknown</option>
    </select>
  </div>

  <!-- Reporting Sequence -->
 
    <div class="form-cell" style="flex: 0 0 200px;">
      <label for="testStage">Evaluation Testing Stage:</label>
      <select id="testStage">
        <option value="Pre-Test Evaluation">Pre-Test Evaluation</option>
        <option value="Final Results Evaluation">Final Results Evaluation</option>
      </select>
    </div>
  </div>


  <input type="hidden" id="pressureReliefConfirmed" value="false" />

  <!-- LIQUID PORT RELIEF CHECK MODAL -->
  <div id="liquidPortReliefCheckModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <h3>üßØ Pressure Relief Observation</h3>
      <p><strong>Action Required:</strong> Start the vehicle. Set A/C to MAX. Watch the high-side gauge and listen for an audible hiss.</p>
      <p>Was a pressure relief (hiss) heard?</p>
      <div style="display: flex; gap: 10px; justify-content: space-between;">
        <button class="yes" onclick="handleLiquidPortReliefResponse(true)">‚úÖ No Relief Heard</button>
<button class="no" onclick="handleLiquidPortReliefResponse(false)">‚ùå Relief Heard</button>
      </div>
    </div>
  </div>

  <!-- ADVANCED / DYNAMIC FIELDS (HIDDEN UNTIL STATIC PASS) -->
<div id="advancedFieldsWrapper" style="display: none;">
    <div class="form-cell" style="flex: 0 0 200px;">
      <label for="chargedStatus">Was a recovery/recharge just performed?</label>
      <select id="chargedStatus">
        <option value="not_charged">No</option>
        <option value="charged">Yes</option>
      </select>
    </div>


  <!-- Tech Note -->
  <div style="margin-top: 12px; margin-bottom: 8px;">
    <strong>Tech Note:</strong> For best results, run the engine at 800+ RPM, A/C ON MAX, Vent to outside, Blower MAX, condenser fan active.
  </div>

  <!-- Row: Factory Charge + Unit -->
  <!-- <div class="form-row charge-unit-row"> -->

    <div class="form-cell" style="display: flex; align-items: flex-end; gap: 2px;">
      <div style="flex: 1 1;">
        <label for="factoryCharge">Factory Charge (oz):</label>
        <input type="number" id="factoryCharge" maxlength="5" placeholder="e.g. 20" style="margin-right: 0;" />
      </div>
      <div style="width: 40px;">
        <label for="chargeUnit" style="opacity: 0; height: 0; margin: 0; padding: 0;">Unit</label> 
        <select id="chargeUnit" style="margin-left: 0; width: 100%;">
          <option value="oz">oz</option>
          <option value="lb">lb</option>
          <option value="g">g</option>
        </select>
      </div>
    </div>

  <!-- Row: Temp Tool + High Side Port -->
  

    <div class="form-cell">
      <label for="tempSource">Temp Sensing Tool:</label>
      <select id="tempSource">
        <option value="ir-shiny" selected>IR Gun (Shiny Metal)</option>
        <option value="ir-black">IR Gun (Black Tape)</option>
        <option value="contact">Contact Probe / Clamp</option>
      </select>
    </div>

    <div class="form-cell" >
      <label for="highSidePortType">High-Side Port Location:</label>
      <select id="highSidePortType">
        <option value="liquid" selected>üü† Liquid Line (post-condenser)</option>
        <option value="discharge">üî¥ Discharge Line (pre-condenser)</option>
        <option value="unknown">‚ö´Ô∏è Unknown</option>
      </select>
    </div>
 
<!-- Row: Expansion Device -->
    <div class="form-cell">
      <label for="expansionDevice">Expansion Device:</label>
      <select id="expansionDevice">
        <option value="txv">TXV</option>
        <option value="orifice">Orifice Tube</option>
      </select>
    </div>

  <div class="form-cell">
    <label for="evapTempSource">Evap Temp Source:</label>
    <select id="evapTempSource">
      <option value="line">Suction Line</option>
      <option value="sensor">ETS Sensor</option>
    </select>
  </div>

<div class="form-cell">
    <label for="ihxEquipped">Is system equipped with an IHX-manifold?</label>
    <select id="ihxEquipped">
      <option value="no">No ‚Äî Standard loop</option>
      <option value="yes">Yes ‚Äî IHX present</option>
    </select>

  <div class="form-cell">
    <label for="compressorType">Compressor Type:</label>
    <select id="compressorType">
      <option value="vdc_clutched">VDC (Clutch)</option>
      <option value="vdc_clutchless">VDC (Clutchless)</option>
      <option value="fixed">Fixed</option>
      <option value="scroll">Scroll</option>
    </select>
  </div>



<button id="testPointHelpBtn" style="font-size: 0.85em; margin-top: 8px;">TP#'s ü§î Temperature Test Points?</button>

<!-- Row 1: Low-side & Evap Data -->
<div class="form-row">
  <div class="form-cell">
    <label for="evapPressure">üîµ Low-Side (PSI):</label>
    <input type="number" id="evapPressure" placeholder="e.g. 30psi" />
   <div id="lowSatTempDisplay" style="font-size: 1em; color: #0074D9; margin-top: 0px;"></div>
</div>
  <div class="form-cell">
    <label for="evapOutlet">Evaporator Outlet Temp (¬∞F):</label>
    <input type="number" id="evapOutlet" placeholder="TP# 1 - e.g. (55¬∞F)" />
  </div>
</div>

<!-- Row 2: High-side & Compressor Data -->
<div class="form-row">
  <div class="form-cell">
    <label for="highPressure">üî¥ High-Side (PSI):</label>
    <input type="number" id="highPressure" placeholder="e.g. 150psi" />
    <div id="highSatTempDisplay" style="font-size: 1em; color: #FF4136; margin-top: 0px;"></div>
  </div>
 <div class="form-cell">
    <label for="outlet">Condenser Outlet Temp (¬∞F):</label>
    <input type="number" id="outlet" placeholder="TP# 2 - e.g. (92¬∞F)" />
  </div>
</div>

  <div class="form-cell" id="txvBlock" style="display: none;">
    <label for="tempAtTXV">TXV Inlet Temp (¬∞F):</label>
    <input type="number" id="tempAtTXV" placeholder="TP# 2 - e.g. TXV Inlet Temp (90¬∞F)" />
  </div>

    <style>
      .form-row { display: flex; align-items: center; gap: 20px; margin-bottom: 8px; }
      .form-cell { flex: 1; }
      input, select { box-sizing: border-box; }
    </style>

<!-- Row 3: Center Vent & ... -->
<div class="form-row" style="display: flex; align-items: center; gap: 20px;">
  <div style="flex: 0 0 200px;">
    <label for="vent">Center Vent Temp(¬∞F):</label>
	<input type="number" id="vent" placeholder="e.g. 55" />
  </div>
  <div id="ventMessage" style="flex: 1; font-size: 0.85em; color: #0074D9; line-height: 1.4;"></div>
</div>


    <div id="testPointHelpBlock" style="display: none; margin-top: 8px;">
      <button id="testPointHelpBtn2" style="font-size: 0.85em;">TP#'s ü§î Temperature Test Points?</button>
    </div>
  </div>

  <div class="form-row" style="margin-top: 12px;">
    <div class="form-cell">
      <label for="techNotes">Technician Observations:</label>
      <textarea id="techNotes" rows="4" placeholder="Enter notes, findings, recommendations‚Ä¶"></textarea>
    </div>
  </div>

  <div class="form-row" style="margin-top: 12px;">
    <div class="form-cell">
      <label for="photos">Attach Photos (Max 5):</label>
      <input type="file" id="photos" accept="image/*" multiple capture="environment" />
      <div id="photoPreview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;"></div>
    </div>
  </div>
</div>
  <div class="button-group" style="margin-top: 16px;">
    <button id="evaluateBtn">Dynamic Testing</button>
    <button id="triageBtn" class="confirm">üõ† Triage Helper</button>
<pre id="triageResults" style="white-space:pre-wrap; margin-top:10px;"></pre>
    <button id="printBtn">üñ®Ô∏è Print</button>
    <button id="downloadBtn" onclick="downloadPDF()">Save as PDF üìÑ</button>
</div>

  <div id="output" class="result"></div>

<!-- Chat Box Container -->
<div class="chat-container">
  <div class="chat-header">Autotech Intelligence</div>
  <div id="cw_messages" class="chat-log cw_messages"></div>
  <div id="customerSummary" style="display:none;"></div>  
  <div class="footer">By Peter Sarantidis</div>
</div>



  <footer style="text-align: center; margin-top: 40px; font-size: 0.85em; color: #666;">
    ¬©2025 Peter Sarantidis ‚Äì ‚ùÑÔ∏è A/C Triage Pro v3.9 X Œ≤eta ‚Äì ASE Master Tech ‚Äì Advanced SME
  </footer>


<script>
    // ‚îÄ‚îÄ‚îÄ stripHTML: convert an element‚Äôs innerHTML into plain text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function stripHTML(html) {
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = html;
      return tempDiv.innerText.trim();
    }

    // ‚îÄ‚îÄ‚îÄ getEvaluationReport: grab #output innerHTML and strip it ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getEvaluationReport() {
      const reportHTML = document.getElementById("output").innerHTML.trim();
      return reportHTML ? stripHTML(reportHTML) : null;
    }

    // ‚îÄ‚îÄ‚îÄ Modal Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showModal(id) {
      const modal = document.getElementById(id);
      if (modal) {
        modal.style.display = "flex";
      }
    }
    function hideModal(id) {
      const modal = document.getElementById(id);
      if (modal) {
        modal.style.display = "none";
      }
    }
    
    document.getElementById("helpBtn").addEventListener("click", () => showModal("helpPopup"));
    document.getElementById("testPointHelpBtn").addEventListener("click", () => showModal("testPointPopup"));
    //document.getElementById("testPointHelpBtn2").addEventListener("click", () => showModal("testPointPopup"));
    document.getElementById("changeBrandingBtn").addEventListener("click", () => showModal("brandingModal"));

    document.querySelectorAll(".modal button").forEach(btn => {
      btn.addEventListener("click", () => {
        const modal = btn.closest(".modal");
        if (modal && modal.id) hideModal(modal.id);
      });
    });

    // ‚îÄ‚îÄ‚îÄ BRANDING STORAGE & RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function saveBranding() {
      const shopName = document.getElementById("shopNameInput").value.trim();
      const contact  = document.getElementById("shopContactInput").value.trim();
      const logoInput = document.getElementById("shopLogoInput");
      if (!shopName) {
        alert("Please enter a shop name.");
        return;
      }
      const brandingData = { shopName, contact, logo: "" };
      const file = logoInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          brandingData.logo = e.target.result;
          localStorage.setItem("shopBranding", JSON.stringify(brandingData));
          hideModal("brandingModal");
          renderBranding();
        };
        reader.readAsDataURL(file);
      } else {
        const existing = JSON.parse(localStorage.getItem("shopBranding") || "{}");
        brandingData.logo = existing.logo || "";
        localStorage.setItem("shopBranding", JSON.stringify(brandingData));
        hideModal("brandingModal");
        renderBranding();
      }
    }
    function renderBranding() {
      const branding = JSON.parse(localStorage.getItem("shopBranding") || "{}");
      const header = document.getElementById("brandingHeader");
      if (!branding.shopName) {
        showModal("brandingModal");
        return;
      }
      header.innerHTML = `
        ${branding.logo ? `<img src="${branding.logo}" alt="Logo" style="max-height:60px; display:block; margin: 0 auto 10px;" />` : ""}
        <div style="font-size: 1.4em; font-weight: bold;">${branding.shopName}</div>
        ${branding.contact ? `<div style="font-size: 0.9em; color: #555;">${branding.contact}</div>` : ""}
      `;
    }
    renderBranding(); // on page load

// Evaluation‚ÄêType dropdown and servicePrompt elements
document.addEventListener("DOMContentLoaded", () => {
document.getElementById("testStage").addEventListener("change", function () {
  const serviceDiv = document.getElementById("servicePrompt");
  const serviceSelect = document.getElementById("serviceInterval");

  if (this.value === "Final Results Evaluation") {
    // Hide the prompt and force ‚ÄúRecently‚Äù
    serviceSelect.value = "Recently";
    serviceDiv.style.display = "none";
  } else {
    // Pre-Test: show prompt with no selection
    serviceSelect.value = "";
    serviceSelect.setAttribute("placeholder", "Select one‚Ä¶");
    serviceDiv.style.display = "block";
  }
});
});

</script>

<script>

function rootCause() {
  // 1) grab all the numbers we need
  const ambient = parseFloat(document.getElementById("ambient").value) || 0;
  const rh      = parseFloat(document.getElementById("rh").value)      || 0;
  const vent    = parseFloat(document.getElementById("vent").value)    || 0;
  const evapP   = parseFloat(document.getElementById("evapPressure").value) || 0;
  const highP   = parseFloat(document.getElementById("highPressure").value) || 0;
  const superheat   = parseFloat(document.getElementById("evapOutlet").value) - interpolate(ptTable[document.getElementById("refrigerant").value], evapP);
  const condSat     = interpolate(ptTable[document.getElementById("refrigerant").value], highP);
  const subcooling  = condSat - parseFloat(document.getElementById("outlet").value);
  const percentFill = Math.round((condSat / (ambient + 25)) * 100);
  const compRatio   = evapP > 0 ? (highP / evapP) : 0;

  // 2) compute expected ranges
  const ventRange = getExpectedVentDelta(ambient);
  const condRange = getExpectedCondDelta(ambient, rh, document.getElementById("tempSource").value, document.getElementById("refrigerant").value);
  const isYF      = document.getElementById("refrigerant").value === "r1234yf";
  const subMin    = isYF ? 8  : 10;
  const subMax    = isYF ? 18 : 20;
  const highRatio = document.getElementById("compressorType").value.includes("vdc")
                    ? (ambient >= 90 ? 4.8 : 4.5)
                    : (ambient >= 90 ? 4.5 : 4.0);

  // 3) build a list of all failing conditions
  const causes = [];

  // charge
  if (percentFill < 95) causes.push("Under-charged system (check for leaks & add refrigerant).");
  if (percentFill > 105) causes.push("Over-charged system (recover excess refrigerant).");

  // airflow / vent
const ventDelta = ambient - vent; // actual vent temp drop

if (ventDelta < ventRange.min) causes.push("Low Vent ŒîT ‚Üí poor airflow (dirty blower/filter or blend-door fault).");
if (ventDelta > ventRange.max) causes.push("High Vent ŒîT ‚Üí possible over-charge or recirc door stuck.");

  // condenser
  if (condSat - ambient < condRange.min) causes.push("Low Condenser ŒîT ‚Üí restricted condenser airflow or low refrigerant.");
  if (condSat - ambient > condRange.max) causes.push("High Condenser ŒîT ‚Üí over-charge or excessive airflow.");

  // compression
  if (compRatio < 2.5) causes.push("Low Compression Ratio ‚Üí under-charge or slipping compressor.");
  if (compRatio > highRatio) causes.push("High Compression Ratio ‚Üí over-charge or system restriction.");

  // superheat
  if (superheat < 10) causes.push("Low Superheat (<10¬∞F) ‚Üí TXV overfeeding or oversized orifice.");
  if (superheat > 15) causes.push("High Superheat (>15¬∞F) ‚Üí under-charge or restriction.");

  // subcooling
  if (subcooling < subMin) causes.push(`Low Subcooling (<${subMin}¬∞F) ‚Üí under-charge or poor condenser airflow.`);
  if (subcooling > subMax) causes.push(`High Subcooling (>${subMax}¬∞F) ‚Üí over-charge or bypass condition.`);

  // 4) if nothing failed, all good!
  if (causes.length === 0) {
    return "‚úÖ All key values are within spec ‚Äî no obvious root-cause detected.";
  }

  // 5) otherwise, return a bullet-list of suspects
  return "‚ö†Ô∏è Possible root causes:\n‚Ä¢ " + causes.join("\n‚Ä¢ ");
}

// hook it up
document.getElementById("triageBtn").addEventListener("click", () => {
  const result = rootCause();
  // you can show this however you like‚Ä¶ alert, console, or inject into the page:
  alert(result);
});

    // ‚îÄ‚îÄ‚îÄ Toggle TXV Input based on IHX dropdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById("ihxEquipped").addEventListener("change", function() {
      const txvBlock = document.getElementById("txvBlock");
      txvBlock.style.display = this.value === "yes" ? "flex" : "none";
    });
    // ensure correct visibility on load
    document.addEventListener("DOMContentLoaded", () => {
      const ihxSelect = document.getElementById("ihxEquipped");
      const txvBlock = document.getElementById("txvBlock");
      if (ihxSelect && txvBlock) {
        txvBlock.style.display = ihxSelect.value === "yes" ? "flex" : "none";
      }
    });

    // ‚îÄ‚îÄ‚îÄ FETCH VEHICLE DATA from VIN (NHTSA) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function fetchVehicleData() {
      const vinInput = document.getElementById("vin");
      const vin = vinInput.value.trim().toUpperCase();
      if (vin.length !== 17) {
        document.getElementById("vehicle").value = "";
        return;
      }
      const url = `https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`;
      try {
        const response = await fetch(url);
        const { Results } = await response.json();
        const vehicleYear  = Results.find(r => r.Variable === "Model Year")?.Value || "";
        const vehicleMake  = Results.find(r => r.Variable === "Make")?.Value       || "";
        const vehicleModel = Results.find(r => r.Variable === "Model")?.Value      || "";
        const ymm = [vehicleYear, vehicleMake, vehicleModel].filter(Boolean).join(" ");
        document.getElementById("vehicle").value = ymm || "Re-Check VIN";
        autoToggleIHXFromVIN();
      } catch (err) {
        console.error("VIN decode error:", err);
        document.getElementById("vehicle").placeholder = "VIN Decoder unavailable, enter YMM manually";
      }
    }

  // ‚îÄ‚îÄ‚îÄ OEM Refrigerant Adoption Timeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const refrigerantTimeline = [
    { makes: [/CHRYSLER/, /JEEP.*CHEROKEE/],     startYear: 2013 },
    { makes: [/HONDA/, /SUBARU/],                 startYear: 2017 },
    { makes: [/CHEVROLET/, /BUICK/, /GMC/, /CADILLAC/], startYear: 2018 },
    { makes: [/.*/],                              startYear: 2021 }
  ];

  function autoToggleIHXFromVIN() {
    const vehicleStr = (document.getElementById("vehicle").value || "").toUpperCase();
    const yearMatch  = vehicleStr.match(/(20\d{2})/);
    const yr         = yearMatch ? parseInt(yearMatch[1], 10) : null;
    const isMB       = /MERCEDES-BENZ/.test(vehicleStr);

    // IHX toggle (unchanged)
    const ihxPatterns = [ /* ‚Ä¶your list‚Ä¶ */ ];
    const ihxDropdown = document.getElementById("ihxEquipped");
    if (ihxDropdown) {
      const ihxOn = ihxPatterns.some(p => p.test(vehicleStr) && (!yr || yr >= 2015));
      ihxDropdown.value = ihxOn ? "yes" : "no";
      document.getElementById("txvBlock").style.display = ihxOn ? "flex" : "none";
    }

    // Refrigerant dropdown
    const dd = document.getElementById("refrigerant");
    if (!dd || !yr) return;
    dd.classList.remove("flash-refrig");

    // 1) Mercedes-Benz < 2021
    if (isMB && yr < 2021) {
      if (yr > 2016) {
        // 2017‚Äì2020 ‚Üí R-134a + flash
        dd.value = "r134a";
        dd.classList.add("flash-refrig");
      } else {
        // ‚â§ 2016 ‚Üí r134a, no flash
        dd.value = "r134a";
      }
      return; // skip timeline for MB < 2021
    }

    // 2) All others (including MB ‚â• 2021) ‚Üí timeline lookup
    let pick = "r134a";
    for (const rule of refrigerantTimeline) {
      if (yr >= rule.startYear && rule.makes.some(rx => rx.test(vehicleStr))) {
        pick = "r1234yf";
        break;
      }
    }
    dd.value = pick;
  }

  // Hook into VIN decode & manual YMM entry
  document.getElementById("vin")
    .addEventListener("input", () => setTimeout(autoToggleIHXFromVIN, 200));
  document.getElementById("vehicle")
    .addEventListener("input", autoToggleIHXFromVIN);
    
// ‚îÄ‚îÄ‚îÄ flash the Refrigerant type if unknown Field & requireField     

function flashField(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.border = "2px solid #FF4136";
      el.focus();
      setTimeout(() => { el.style.border = ""; }, 1500);
    }
    function requireField(id, label) {
      const el = document.getElementById(id);
      if (!el || !el.value.trim()) {
        flashField(id);
        alert(`Please enter the "${label}" before proceeding.`);
        return false;
      }
      return true;
    }

    // ‚îÄ‚îÄ‚îÄ WEATHER FETCH (OpenWeatherMap) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById("zipCode").addEventListener("input", function() {
      const zip = this.value.trim();
      const weatherStatus = document.getElementById("weatherStatus");
      if (zip.length === 5 && /^\d{5}$/.test(zip)) {
        weatherStatus.textContent = "Fetching weather‚Ä¶";
        fetch(`https://api.openweathermap.org/data/2.5/weather?zip=${zip},us&units=imperial&appid=c1f623f582996a080fa582661efc36b5`)
          .then(res => res.json())
          .then(data => {
            if (data && data.main) {
              const ambientField = document.getElementById("ambient");
              const rhField = document.getElementById("rh");
              if (!ambientField.value) ambientField.value = Math.round(data.main.temp);
              if (!rhField.value) rhField.value = data.main.humidity;
              evaluateStaticPressure();
              weatherStatus.textContent = `‚úÖ Weather: ${Math.round(data.main.temp)}¬∞F, RH: ${data.main.humidity}%`;
              window.fetchedWeather = {
                ambient: Math.round(data.main.temp),
                rh: data.main.humidity
              };
            } else {
              weatherStatus.textContent = "‚ö†Ô∏è Invalid ZIP or data unavailable.";
            }
          })
          .catch(() => {
            weatherStatus.textContent = "‚ö†Ô∏è Weather fetch failed.";
          });
      } else {
        weatherStatus.textContent = "";
      }
    });

    // ‚îÄ‚îÄ‚îÄ Photo Preview & Attachment (max 5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let attachedImages = [];
    function previewPhotos() {
      const input = document.getElementById("photos");
      const preview = document.getElementById("photoPreview");
      const files = Array.from(input.files).slice(0, 5 - attachedImages.length);
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          if (attachedImages.length < 5) {
            const img = document.createElement("img");
            img.src = e.target.result;
            attachedImages.push(e.target.result);
            img.style.maxWidth = "120px";
            img.style.border = "1px solid #ccc";
            img.style.padding = "4px";
            img.style.background = "#fff";
            preview.appendChild(img);
          }
        };
        reader.readAsDataURL(file);
      });
      input.value = "";
    }
    document.getElementById("photos").addEventListener("change", previewPhotos);
</script>


<script>
// ‚îÄ‚îÄ Global Utility Functions & Shared Constants ‚îÄ‚îÄ
const STATIC_LOW_BUFFER  = 5; // psi buffer for low side check
const STATIC_HIGH_BUFFER = 5; // psi buffer for high side check

    // ‚îÄ‚îÄ‚îÄ PT CHART TABLES & INTERPOLATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ptTable = {
      r134a: [
        { psi: 6.5, temp: 0 }, { psi: 7.0, temp: 1 }, { psi: 7.5, temp: 2 },
        { psi: 8.0, temp: 3 }, { psi: 8.5, temp: 4 }, { psi: 9.1, temp: 5 },
        { psi: 9.6, temp: 6 }, { psi: 10.2, temp: 7 }, { psi: 10.8, temp: 8 },
        { psi: 11.3, temp: 9 }, { psi: 11.9, temp: 10 }, { psi: 12.5, temp: 11 },
        { psi: 13.1, temp: 12 }, { psi: 13.8, temp: 13 }, { psi: 14.4, temp: 14 },
        { psi: 15.0, temp: 15 }, { psi: 15.7, temp: 16 }, { psi: 16.4, temp: 17 },
        { psi: 17.0, temp: 18 }, { psi: 17.7, temp: 19 }, { psi: 18.4, temp: 20 },
        { psi: 19.1, temp: 21 }, { psi: 19.9, temp: 22 }, { psi: 20.6, temp: 23 },
        { psi: 21.3, temp: 24 }, { psi: 22.1, temp: 25 }, { psi: 22.9, temp: 26 },
        { psi: 23.7, temp: 27 }, { psi: 24.5, temp: 28 }, { psi: 25.3, temp: 29 },
        { psi: 26.1, temp: 30 }, { psi: 26.9, temp: 31 }, { psi: 27.8, temp: 32 },
        { psi: 28.6, temp: 33 }, { psi: 29.5, temp: 34 }, { psi: 30.4, temp: 35 },
        { psi: 31.3, temp: 36 }, { psi: 32.2, temp: 37 }, { psi: 33.1, temp: 38 },
        { psi: 34.1, temp: 39 }, { psi: 35.0, temp: 40 }, { psi: 36.0, temp: 41 },
        { psi: 37.0, temp: 42 }, { psi: 38.0, temp: 43 }, { psi: 39.0, temp: 44 },
        { psi: 40.1, temp: 45 }, { psi: 41.1, temp: 46 }, { psi: 42.2, temp: 47 },
        { psi: 43.2, temp: 48 }, { psi: 44.3, temp: 49 }, { psi: 45.4, temp: 50 },
        { psi: 46.6, temp: 51 }, { psi: 47.7, temp: 52 }, { psi: 50.0, temp: 54 },
        { psi: 51.2, temp: 55 }, { psi: 52.4, temp: 56 }, { psi: 53.6, temp: 57 },
        { psi: 48.9, temp: 53 }, { psi: 54.9, temp: 58 }, { psi: 56.1, temp: 59 },
        { psi: 57.4, temp: 60 }, { psi: 58.7, temp: 61 }, { psi: 60.0, temp: 62 },
        { psi: 61.3, temp: 63 }, { psi: 62.7, temp: 64 }, { psi: 64.0, temp: 65 },
        { psi: 65.4, temp: 66 }, { psi: 66.8, temp: 67 }, { psi: 68.2, temp: 68 },
        { psi: 69.7, temp: 69 }, { psi: 71.1, temp: 70 }, { psi: 72.6, temp: 71 },
        { psi: 74.1, temp: 72 }, { psi: 75.6, temp: 73 }, { psi: 77.1, temp: 74 },
        { psi: 78.7, temp: 75 }, { psi: 80.2, temp: 76 }, { psi: 81.8, temp: 77 },
        { psi: 83.4, temp: 78 }, { psi: 85.0, temp: 79 }, { psi: 86.7, temp: 80 },
        { psi: 88.4, temp: 81 }, { psi: 90.0, temp: 82 }, { psi: 91.8, temp: 83 },
        { psi: 93.5, temp: 84 }, { psi: 95.2, temp: 85 }, { psi: 97.0, temp: 86 },
        { psi: 98.8, temp: 87 }, { psi: 100.6, temp: 88 }, { psi: 102.5, temp: 89 },
        { psi: 104.3, temp: 90 }, { psi: 106.2, temp: 91 }, { psi: 108.1, temp: 92 },
        { psi: 110.0, temp: 93 }, { psi: 112.0, temp: 94 }, { psi: 114.0, temp: 95 },
        { psi: 115.9, temp: 96 }, { psi: 118.0, temp: 97 }, { psi: 120.0, temp: 98 },
        { psi: 122.1, temp: 99 }, { psi: 124.2, temp: 100 }, { psi: 126.3, temp: 101 },
        { psi: 128.4, temp: 102 }, { psi: 130.6, temp: 103 }, { psi: 132.8, temp: 104 },
        { psi: 135.0, temp: 105 }, { psi: 137.2, temp: 106 }, { psi: 139.5, temp: 107 },
        { psi: 141.7, temp: 108 }, { psi: 144.0, temp: 109 }, { psi: 146.4, temp: 110 },
        { psi: 148.7, temp: 111 }, { psi: 151.1, temp: 112 }, { psi: 153.5, temp: 113 },
        { psi: 156.0, temp: 114 }, { psi: 158.4, temp: 115 }, { psi: 160.9, temp: 116 },
        { psi: 163.5, temp: 117 }, { psi: 166.0, temp: 118 }, { psi: 168.6, temp: 119 },
        { psi: 171.2, temp: 120 }, { psi: 173.8, temp: 121 }, { psi: 176.5, temp: 122 },
        { psi: 179.1, temp: 123 }, { psi: 181.8, temp: 124 }, { psi: 184.6, temp: 125 },
        { psi: 187.4, temp: 126 }, { psi: 190.2, temp: 127 }, { psi: 193.0, temp: 128 },
        { psi: 195.8, temp: 129 }, { psi: 198.7, temp: 130 }, { psi: 201.6, temp: 131 },
        { psi: 204.6, temp: 132 }, { psi: 207.6, temp: 133 }, { psi: 210.6, temp: 134 },
        { psi: 213.6, temp: 135 }, { psi: 216.7, temp: 136 }, { psi: 219.8, temp: 137 },
        { psi: 222.9, temp: 138 }, { psi: 226.0, temp: 139 }, { psi: 229.2, temp: 140 },
        { psi: 232.5, temp: 141 }, { psi: 235.7, temp: 142 }, { psi: 239.0, temp: 143 },
        { psi: 242.3, temp: 144 }, { psi: 245.7, temp: 145 }, { psi: 249.1, temp: 146 },
        { psi: 252.5, temp: 147 }, { psi: 255.9, temp: 148 }, { psi: 259.4, temp: 149 },
        { psi: 262.9, temp: 150 }, { psi: 266.4, temp: 151 }, { psi: 269.9, temp: 152 },
        { psi: 273.5, temp: 153 }, { psi: 277.1, temp: 154 }, { psi: 280.7, temp: 155 },
        { psi: 284.4, temp: 156 }, { psi: 288.1, temp: 157 }, { psi: 291.8, temp: 158 },
        { psi: 295.6, temp: 159 }, { psi: 299.3, temp: 160 }, { psi: 303.1, temp: 161 },
        { psi: 306.9, temp: 162 }, { psi: 310.8, temp: 163 }, { psi: 314.7, temp: 164 },
        { psi: 318.6, temp: 165 }, { psi: 322.5, temp: 166 }, { psi: 326.5, temp: 167 },
        { psi: 330.5, temp: 168 }, { psi: 334.5, temp: 169 }, { psi: 338.6, temp: 170 },
        { psi: 342.6, temp: 171 }, { psi: 346.7, temp: 172 }, { psi: 350.9, temp: 173 },
        { psi: 355.0, temp: 174 }, { psi: 359.2, temp: 175 }, { psi: 363.4, temp: 176 },
        { psi: 367.7, temp: 177 }, { psi: 372.0, temp: 178 }, { psi: 376.3, temp: 179 },
        { psi: 380.6, temp: 180 }, { psi: 385.0, temp: 181 }, { psi: 389.4, temp: 182 },
        { psi: 393.8, temp: 183 }, { psi: 398.3, temp: 184 }, { psi: 400.0, temp: 185 }
      ],
      r1234yf: [
        { psi: 9, temp: 0 }, { psi: 11, temp: 4 }, { psi: 14, temp: 8 },
        { psi: 16, temp: 12 }, { psi: 19, temp: 16 }, { psi: 20, temp: 18 },
        { psi: 23, temp: 22 }, { psi: 24, temp: 23 }, { psi: 25, temp: 24 },
        { psi: 28, temp: 28 }, { psi: 31, temp: 32 }, { psi: 33, temp: 34 },
        { psi: 35, temp: 36 }, { psi: 37, temp: 38 }, { psi: 38, temp: 40 },
        { psi: 40, temp: 42 }, { psi: 42, temp: 44 }, { psi: 44, temp: 46 },
        { psi: 47, temp: 48 }, { psi: 49, temp: 50 }, { psi: 51, temp: 52 },
        { psi: 53, temp: 54 }, { psi: 56, temp: 56 }, { psi: 58, temp: 58 },
        { psi: 61, temp: 60 }, { psi: 63, temp: 62 }, { psi: 66, temp: 64 },
        { psi: 68, temp: 66 }, { psi: 71, temp: 68 }, { psi: 74, temp: 70 },
        { psi: 77, temp: 72 }, { psi: 80, temp: 74 }, { psi: 83, temp: 76 },
        { psi: 86, temp: 78 }, { psi: 89, temp: 80 }, { psi: 92, temp: 82 },
        { psi: 96, temp: 84 }, { psi: 99, temp: 86 }, { psi: 102, temp: 88 },
        { psi: 106, temp: 90 }, { psi: 110, temp: 92 }, { psi: 113, temp: 94 },
        { psi: 117, temp: 96 }, { psi: 121, temp: 98 }, { psi: 125, temp: 100 },
        { psi: 129, temp: 102 }, { psi: 133, temp: 104 }, { psi: 137, temp: 106 },
        { psi: 142, temp: 108 }, { psi: 146, temp: 110 }, { psi: 150, temp: 112 },
        { psi: 155, temp: 114 }, { psi: 160, temp: 116 }, { psi: 164, temp: 118 },
        { psi: 169, temp: 120 }, { psi: 174, temp: 122 }, { psi: 179, temp: 124 },
        { psi: 184, temp: 126 }, { psi: 190, temp: 128 }, { psi: 195, temp: 130 },
        { psi: 200, temp: 132 }, { psi: 206, temp: 134 }, { psi: 212, temp: 136 },
        { psi: 218, temp: 138 }, { psi: 223, temp: 140 }, { psi: 229, temp: 142 },
        { psi: 236, temp: 144 }, { psi: 242, temp: 146 }, { psi: 248, temp: 148 },
        { psi: 255, temp: 150 }, { psi: 261, temp: 152 }, { psi: 268, temp: 154 },
        { psi: 275, temp: 156 }, { psi: 282, temp: 158 }, { psi: 289, temp: 160 },
        { psi: 296, temp: 162 }, { psi: 304, temp: 164 }, { psi: 311, temp: 166 },
        { psi: 319, temp: 168 }, { psi: 326, temp: 170 }, { psi: 334, temp: 172 },
        { psi: 342, temp: 174 }, { psi: 351, temp: 176 }, { psi: 359, temp: 178 },
        { psi: 368, temp: 180 }, { psi: 376, temp: 182 }, { psi: 385, temp: 184 },
        { psi: 394, temp: 186 }, { psi: 403, temp: 188 }, { psi: 413, temp: 190 }
      ]
    };

    function interpolate(table, psi) {
      for (let i = 0; i < table.length - 1; i++) {
        const low = table[i], high = table[i + 1];
        if (psi >= low.psi && psi <= high.psi) {
          return low.temp + ((psi - low.psi) / (high.psi - low.psi)) * (high.temp - low.temp);
        }
      }
      return table[0].temp;
    }

    // ‚îÄ‚îÄ‚îÄ Get Static Pressure Range ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getStaticPressureRange(ambientTemp, refrigerant) {
      const table = ptTable[refrigerant];
      if (!table || table.length <2) return { min: NaN, max: NaN, center: NaN };
      let lower = null, upper = null;
      for (let i = 0; i < table.length - 1; i++) {
        const t1 = table[i].temp, t2 = table[i + 1].temp;
        if (ambientTemp >= t1 && ambientTemp <= t2) {
          lower = table[i]; upper = table[i + 1];
          break;
        }
      }
      if (!lower || !upper) return { min: NaN, max: NaN, center: NaN };
      const ratio = (ambientTemp - lower.temp) / (upper.temp - lower.temp);
      const interpolatedPsi = lower.psi + ratio * (upper.psi - lower.psi);
      return {
        center: interpolatedPsi,
    min: interpolatedPsi - STATIC_LOW_BUFFER,
    max: interpolatedPsi + STATIC_HIGH_BUFFER
      };
    }

// Helper to strip HTML for report/plaintext export
function stripHTML(html) {
  const tempDiv = document.createElement("div");
  tempDiv.innerHTML = html;
  return tempDiv.innerText.trim();
}

</script>

<script>
// ‚îÄ‚îÄ‚îÄ Evaluate Static Pressure (on ambient/static input) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function evaluateStaticPressure() {
  const ambient = parseFloat(document.getElementById("ambient").value);
  const refrigerant = document.getElementById("refrigerant").value;
  const staticPSI = parseFloat(document.getElementById("staticPressure").value);
  const staticDisplay = document.getElementById("staticPressureRangeDisplay");
  const output = document.getElementById("output");

  if (isNaN(ambient)) {
    staticDisplay.innerHTML = `ü´ß Expected Static Pressure (Engine Off): <em>Enter ambient temp!</em>`;
    output.innerHTML = `
      <div class="report-section" style="border-left: 4px solid gray;">
        <strong>üå°Ô∏è Ambient Temperature Required</strong><br>
        Please enter a valid ambient temperature to calculate the expected static pressure range.
      </div>`;
    return;
  }

  const range = getStaticPressureRange(ambient, refrigerant);
  // round down min, round up max
  const minVal = Math.floor(range.min);
  const maxVal = Math.ceil(range.max);

  if (isNaN(staticPSI)) {
    staticDisplay.innerHTML = `
      ü´ß Expected Static Pressure (Engine Off) for ${refrigerant.toUpperCase()}: 
      <strong>${minVal} ~ ${maxVal} psi</strong><br>
      <em>Enter Static Pressure (PSI) to diagnose fill state.</em>`;
    output.innerHTML = `
      <div class="report-section" style="border-left: 4px solid gray;">
        <strong>üìù Awaiting Static PSI Input</strong><br>
        Please enter a static pressure reading to determine system condition.<br>
        Use the displayed expected range for guidance.
      </div>`;
    return;
  }

  // Significantly Undercharged (very low)
  if (staticPSI < range.min - 5) {
    staticDisplay.innerHTML = `
      ü´ß Expected Static Pressure (Engine Off) for ${refrigerant.toUpperCase()}: 
      <strong>${minVal} ~ ${maxVal} psi</strong><br>
      <strong>‚ùå Undercharged ‚Äì STOP.</strong><br>
      Static pressure is well below expected range. Perform a leak test, recover refrigerant, and recharge to factory specs.`;
    document.getElementById("advancedFieldsWrapper").style.display = "none";
    output.innerHTML = `
      <div class="report-section" style="border-left: 4px solid red;">
        <strong>‚ùå Undercharged System:</strong><br>
        Static PSI is much lower than expected for today‚Äôs temperature.<br>
        The system likely has a significant leak or is very low on refrigerant.<br>
        We recommend a full leak check, recovery, and recharge before any further diagnostics.
      </div>`;
    return;
  }

  // Slightly Undercharged (borderline low)
  if (staticPSI < range.min) {
    staticDisplay.innerHTML = `
      ü´ß Expected Static Pressure (Engine Off) for ${refrigerant.toUpperCase()}: 
      <strong>${minVal} ~ ${maxVal} psi</strong><br>
      <strong>‚ö†Ô∏è Slightly Low.</strong><br>
      Pressure is just below expected range. On older vehicles, minor loss is normal. Recommend service and top-off if A/C isn't cooling at its best.`;
    document.getElementById("advancedFieldsWrapper").style.display = "block";
    output.innerHTML = `
      <div class="report-section" style="border-left: 4px solid orange;">
        <strong>‚ö†Ô∏è Slightly Low Static Pressure:</strong><br>
        Your reading is a little low for today's temperature. This often happens as vehicles age, especially if the A/C has never been serviced.<br>
        If you notice less cooling than usual, a simple top-off or basic service can help restore comfort and efficiency.
      </div>`;
    return;
  }

  // Overcharged or contamination (significantly above +10 psi)
  if (staticPSI > range.max + 10) {
    staticDisplay.innerHTML = `
      ü´ß Expected Static Pressure (Engine Off) for ${refrigerant.toUpperCase()}: 
      <strong>${minVal} ~ ${maxVal} psi</strong><br>
      <strong>üî¥ Above Range ‚Äì Possible Non-Condensables</strong><br>
      Pressure is well above expected. Let system acclimate, then identify refrigerant and retest.`;
    document.getElementById("advancedFieldsWrapper").style.display = "none";
    output.innerHTML = `
      <div class="report-section" style="border-left: 4px solid red;">
        <strong>üî¥ High Static Pressure:</strong><br>
        The pressure is much higher than expected. This could be due to too much refrigerant, air contamination, or even the wrong refrigerant in the system.<br>
        Allow the system to fully stabilize, then identify and recover as needed before moving forward.
      </div>`;
    return;
  }

  // Slightly High
  if (staticPSI > range.max) {
    staticDisplay.innerHTML = `
      ü´ß Expected Static Pressure (Engine Off) for ${refrigerant.toUpperCase()}: 
      <strong>${minVal} ~ ${maxVal} psi</strong><br>
      <strong>‚ö†Ô∏è Slightly High.</strong><br>
      Pressure slightly exceeds expected. On a hot day, let vehicle cool for 30‚Äì45 min and retest.`;
    document.getElementById("advancedFieldsWrapper").style.display = "block";
    output.innerHTML = `
      <div class="report-section" style="border-left: 4px solid orange;">
        <strong>‚ö†Ô∏è Slightly Elevated Static Pressure:</strong><br>
        Your reading is a bit high. Let the vehicle cool in the shade and retest.<br>
        If the pressure stays high, we recommend a professional inspection and adjustment for best performance.
      </div>`;
    return;
  }

  // Within expected range
  staticDisplay.innerHTML = `
    ü´ß Expected Static Pressure (Engine Off) for ${refrigerant.toUpperCase()}: 
    <strong>${minVal} ~ ${maxVal} psi</strong><br>
    <strong>‚úÖ Within Range.</strong><br>
    Proceed to dynamic testing.`;
  document.getElementById("advancedFieldsWrapper").style.display = "block";
  output.innerHTML = `
    <div class="report-section" style="border-left: 4px solid green;">
      <strong>‚úÖ Static Pressure Within Range:</strong><br>
      The system looks properly charged based on today‚Äôs temperature. You can now move forward with engine-running A/C testing.
    </div>`;
}

// --- Event listeners ---
document.getElementById("ambient").addEventListener("input", evaluateStaticPressure);
document.getElementById("staticPressure").addEventListener("input", evaluateStaticPressure);
document.getElementById("refrigerant").addEventListener("change", () => {
  evaluateStaticPressure();
  updateSaturationDisplay();
});
</script>

<script>
    // ‚îÄ‚îÄ‚îÄ Pressure Relief Response ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function handleLiquidPortReliefResponse(heard) {
      hideModal("liquidPortReliefCheckModal");
      const statusField = document.getElementById("pressureReliefConfirmed");
      if (!statusField) return;
      // ‚Äúheard=true‚Äù means ‚Äúno relief heard‚Äù (technician clicked ‚úÖ), so we store ‚Äúno‚Äù
      statusField.value = heard ? "no" : "yes";
      const output = document.getElementById("output");
      if (heard) {
        output.innerHTML = `
          <div class="report-section">
            <strong>üßØ Pressure Relief Observation:</strong><br>
            Technician confirmed <strong>no audible relief</strong> after startup.
          </div>`;
      } else {
        output.innerHTML = `
          <div class="report-section" style="border-left: 4px solid red;">
            <h3 style="text-align: center;">üìÑ A/C System Performance Report</h3>
            <strong>Pressure Relief Event Detected</strong><br>
            Technician confirmed a pressure relief sound after startup.<br>
            üö® <strong>Dynamic A/C testing halted!</strong><br>
            Suspected upstream restriction near condenser inlet. Replace receiver-drier and flush system. For R-1234yf, replace condenser per EPA (non-flushable).
          </div>`;
      }
    }
    document.getElementById("chargedStatus").addEventListener("change", function() {
      if (this.value === "charged") {
        showModal("liquidPortReliefCheckModal");
      }
    });

    // ‚îÄ‚îÄ‚îÄ COMPUTE SATURATION TEMPS & UPDATE UIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getSaturationTemp(pressure, refrigerant) {
      const table = ptTable[refrigerant];
      if (!table || table.length === 0) return NaN;
      for (let i = 0; i < table.length - 1; i++) {
        const p1 = table[i].psi, p2 = table[i + 1].psi;
        const t1 = table[i].temp, t2 = table[i + 1].temp;
        if (pressure >= p1 && pressure <= p2) {
          const ratio = (pressure - p1) / (p2 - p1);
          return t1 + ratio * (t2 - t1);
        }
      }
      return NaN;
    }

    function updateSaturationDisplay() {
      const refrigerant = document.getElementById("refrigerant").value;
      const lowPsi = parseFloat(document.getElementById("evapPressure").value);
      const highPsi = parseFloat(document.getElementById("highPressure").value);
      const lowSatDisplay = document.getElementById("lowSatTempDisplay");
      const highSatDisplay = document.getElementById("highSatTempDisplay");

      // Superheat/subcooling ranges based on refrigerant & expansion device
      let superheatMin, superheatMax, subcoolMin, subcoolMax;
      const expansion = document.getElementById("expansionDevice").value;
      if (refrigerant === "r1234yf") {
        if (expansion === "orifice") {
          superheatMin = 15; superheatMax = 20; subcoolMin = 5; subcoolMax = 15;
        } else {
          superheatMin = 10; superheatMax = 15; subcoolMin = 8; subcoolMax = 18;
        }
      } else {
        if (expansion === "orifice") {
          superheatMin = 15; superheatMax = 20; subcoolMin = 7; subcoolMax = 15;
        } else {
          superheatMin = 10; superheatMax = 15; subcoolMin = 10; subcoolMax = 20;
        }
      }

      // Low-side saturation & superheat range
      if (!isNaN(lowPsi)) {
        const evapSat = interpolate(ptTable[refrigerant], lowPsi);
        const outletMin = (evapSat + superheatMin).toFixed(0);
        const outletMax = (evapSat + superheatMax).toFixed(0);
        lowSatDisplay.innerHTML = `
          Low-Side Sat Temp: <strong>${evapSat.toFixed(0)}¬∞F</strong><br>
          <em>Evaporator Outlet Temp (Superheat): ${outletMin}‚Äì${outletMax}¬∞F</em>
        `;
      } else {
        lowSatDisplay.textContent = "";
      }

      // High-side saturation & subcooling range
      if (!isNaN(highPsi)) {
        const condSat = interpolate(ptTable[refrigerant], highPsi);
        const outletMin = (condSat - subcoolMax).toFixed(0);
        const outletMax = (condSat - subcoolMin).toFixed(0);
        highSatDisplay.innerHTML = `
          High-Side Sat Temp: <strong>${condSat.toFixed(0)}¬∞F</strong><br>
          <em>Condenser Outlet Temp (Subcooling): ${outletMin}‚Äì${outletMax}¬∞F</em>
        `;
      } else {
        highSatDisplay.textContent = "";
      }
    }
    document.getElementById("evapPressure").addEventListener("input", updateSaturationDisplay);
    document.getElementById("highPressure").addEventListener("input", updateSaturationDisplay);
    document.getElementById("expansionDevice").addEventListener("change", updateSaturationDisplay);

    // ‚îÄ‚îÄ‚îÄ Vent ŒîT Expectations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getExpectedVentDelta(ambient) {
      if (ambient <= 35) return { min: 1, max: 2 };
      if (ambient <= 40) return { min: 5, max: 7 };
      if (ambient <= 50) return { min: 10, max: 15 };
      if (ambient <= 70) return { min: 15, max: 25 };
      if (ambient <= 80) return { min: 20, max: 30 };
      if (ambient <= 95) return { min: 25, max: 35 };
      return { min: 30, max: 40 };
    }

    function evaluateEvapTempDifferential(satTemp, evapTemp, source, rh) {
      const diff = evapTemp - satTemp;
      let result = "", tag = "", scoreImpact = 0, rhNote = "";
      if (source === "sensor") {
        if (diff < 0 || isNaN(diff)) {
          result = "‚ùå ETS Sensor Error ‚Äì Negative reading.";
          tag = "CODE-ETS-NEGATIVE";
          scoreImpact = -2;
        } else if (diff >= 5 && diff <= 10) {
          result = "‚úÖ ETS Differential Normal";
          tag = "CODE-ETS-OK";
          scoreImpact = 1;
        } else if (diff < 5) {
          result = "‚ö†Ô∏è ETS Diff Low ‚Äì TXV overfeed or ETS misplacement.";
          tag = "CODE-ETS-LOW";
          scoreImpact = rh > 70 ? 0 : -1;
          if (rh > 70) rhNote = "High humidity adjusts freezing margin.";
        } else if (diff > 15) {
          result = "‚ö†Ô∏è ETS reading too high ‚Äì placement issue.";
          tag = "CODE-ETS-HIGH";
          scoreImpact = -1;
        } else {
          result = "‚ö†Ô∏è ETS Differential Unusual ‚Äì check accuracy.";
          tag = "CODE-ETS-UNKNOWN";
          scoreImpact = 0;
        }
      }
      if (source === "line") {
        if (diff >= 8 && diff <= 15) {
          result = "‚úÖ Suction Line Temp Normal";
          tag = "CODE-SUCTION-OK";
          scoreImpact = 1;
        } else if (diff < 8) {
          result = "‚ö†Ô∏è Outlet Temp Too Cold ‚Äì flooding suspected.";
          tag = "CODE-SUCTION-LOW";
          scoreImpact = rh > 70 ? 0 : -1;
          if (rh > 70) rhNote = "High humidity allows lower outlet temp.";
        } else if (diff > 18) {
          result = "‚ö†Ô∏è Outlet Temp Too Warm ‚Äì poor heat transfer.";
          tag = "CODE-SUCTION-HIGH";
          scoreImpact = -1;
        } else {
          result = "‚ö†Ô∏è Suction Differential Unusual ‚Äì check accuracy.";
          tag = "CODE-SUCTION-UNKNOWN";
          scoreImpact = 0;
        }
      }
      return { result, tag, scoreImpact, rhNote };
    }

    function getSubcoolingStatus(satTemp, outletTemp, refrigerantType) {
      const subcool = satTemp - outletTemp;
      let status = "", tag = "";
      let thresholdLow, thresholdHigh;
      if (refrigerantType === "r1234yf") {
        thresholdLow = 5; thresholdHigh = 18;
      } else {
        thresholdLow = 5; thresholdHigh = 20;
      }
      if (subcool < 0) {
        status = `‚ùå Invalid: Outlet ${outletTemp.toFixed(0)}¬∞F > Sat ${satTemp.toFixed(0)}¬∞F`;
        tag = "CODE-SUBCOOL-INVALID";
      } else if (subcool < thresholdLow) {
        status = `‚ö†Ô∏è Low Subcooling (${subcool.toFixed(0)}¬∞F) ‚Äì Possible undercharge or weak condenser.`;
        tag = "CODE-SUBCOOL-LOW";
      } else if (subcool > thresholdHigh) {
        status = `üî¥ High Subcooling (${subcool.toFixed(0)}¬∞F) ‚Äì Possible overcharge or airflow restriction.`;
        tag = "CODE-SUBCOOL-HIGH";
      } else {
        status = `‚úÖ Normal Subcooling (${subcool.toFixed(0)}¬∞F) ‚Äì Liquid fully condensed.`;
        tag = "CODE-SUBCOOL-NORMAL";
      }
      return { subcooling: subcool.toFixed(0), status, tag };
    }

   function evaluateTPDelta(ambient, condOutlet, tempAtTXV, tempSourceMode) {
  if (isNaN(ambient) || isNaN(condOutlet) || isNaN(tempAtTXV)) {
    return {
      tpDelta: null,
      status: "‚ö†Ô∏è Missing readings.",
      tag: "CODE-TP-INVALID",
      scoreImpact: 0
    };
  }

  let delta = tempAtTXV - condOutlet; // TP#2 ‚Äì TP#3 (TXV Inlet ‚Äì Condenser Outlet)

  // Apply IR bias adjustment if needed
  if (tempSourceMode === "ir-shiny") {
    delta += 2;
  }

  const expected = ambient >= 90 ? 1.5 : 1.0;
  const threshold = expected + 1.0;
  const isIHX = document.getElementById("ihxEquipped").value === "yes";

  if (isIHX) {
    // IHX-equipped systems should show a small TP#2 drop
    if (delta <= 0 && delta >= -3) {
      return {
        tpDelta: Number(delta.toFixed(0)),
        status: `‚úÖ TP#2‚ÄìTP#3 drop ${Math.abs(delta).toFixed(0)}¬∞F normal (IHX).`,
        tag: "CODE-TP-IHX-NORMAL",
        scoreImpact: 1
      };
    } else if (delta < -3) {
      return {
        tpDelta: Number(delta.toFixed(0)),
        status: `‚ö†Ô∏è Excessive TP#2‚ÄìTP#3 drop ${Math.abs(delta).toFixed(0)}¬∞F (IHX).`,
        tag: "CODE-TP-IHX-EXCESSIVE",
        scoreImpact: -1
      };
    } else if (delta > 0 && delta <= 3) {
      return {
        tpDelta: Number(delta.toFixed(0)),
        status: `‚ö†Ô∏è TP#2‚ÄìTP#3 rise ${delta.toFixed(0)}¬∞F unexpected for IHX.`,
        tag: "CODE-TP-IHX-RISE",
        scoreImpact: -1
      };
    } else {
      return {
        tpDelta: Number(delta.toFixed(0)),
        status: `‚ö†Ô∏è Unusual TP#2‚ÄìTP#3 ŒîT ${delta.toFixed(0)}¬∞F (IHX).`,
        tag: "CODE-TP-IHX-OUT",
        scoreImpact: -1
      };
    }
  } else {
    // Non-IHX: slight TP#2 heat gain is acceptable
    if (delta >= 0 && delta <= 2) {
      return {
        tpDelta: Number(delta.toFixed(0)),
        status: `‚úÖ TP#2‚ÄìTP#3 rise ${delta.toFixed(0)}¬∞F normal.`,
        tag: "CODE-TP-NONIHX-NORMAL",
        scoreImpact: 1
      };
    } else if (delta < 0) {
      return {
        tpDelta: Number(delta.toFixed(0)),
        status: `‚ö†Ô∏è Unexpected TP#2‚ÄìTP#3 drop ${Math.abs(delta).toFixed(0)}¬∞F.`,
        tag: "CODE-TP-NONIHX-DROP",
        scoreImpact: -1
      };
    } else {
      return {
        tpDelta: Number(delta.toFixed(0)),
        status: `‚ö†Ô∏è Excessive TP#2‚ÄìTP#3 rise ${delta.toFixed(0)}¬∞F.`,
        tag: "CODE-TP-NONIHX-EXCESS",
        scoreImpact: -1
      };
    }
  }
}


// ‚îÄ‚îÄ‚îÄ Condenser Heat Rejection ŒîT expectations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 
function getExpectedCondDelta(ambient, rh, mode = "ir-shiny", refrigerant = "r134a") {
  let range = { min: 10, max: 20 };

  if (ambient <= 70) {
    range = rh >= 70 ? { min: 12, max: 22 } : { min: 10, max: 20 };
  } else if (ambient <= 85) {
    range = rh >= 70 ? { min: 13, max: 23 } : { min: 11, max: 21 };
  } else if (ambient <= 95) {
    range = rh >= 70 ? { min: 14, max: 24 } : { min: 12, max: 22 };
  } else {
    range = rh >= 70 ? { min: 15, max: 25 } : { min: 13, max: 23 };
  }

  if (mode === "ir-shiny") {
    range.min += 5;
    range.max += 5;
  }

  if (refrigerant.toLowerCase() === "r1234yf") {
    range.min -= 1;
    range.max -= 1;
  }

  return range;
}

function updateVentMessage() {
  const ambient = parseFloat(document.getElementById("ambient").value);
  const vent    = parseFloat(document.getElementById("vent").value);
  const msgDiv  = document.getElementById("ventMessage");

  if (isNaN(ambient) || isNaN(vent)) {
    msgDiv.textContent = "";
    return;
  }

  // ‚Üê use the existing Vent ŒîT ranges
  const { min, max } = getExpectedVentDelta(ambient); 

  const delta = ambient - vent;

  if (delta >= min && delta <= max) {
    msgDiv.innerHTML = `
      ‚úÖ Vent‚Äôs temp drop of ${delta.toFixed(0)}¬∞F is within the 
      expected <strong>${min}‚Äì${max}¬∞F</strong> range for ${ambient}¬∞F ambient.
    `;
  } else if (delta < min) {
    msgDiv.innerHTML = `
      ‚ö†Ô∏è Vent's temp drop is too low: ${delta.toFixed(0)}¬∞F (< ${min}¬∞F). 
      Check airflow (filter, blend-door).
    `;
  } else {
    msgDiv.innerHTML = `
      ‚ö†Ô∏è Vent's temp drop too high: ${delta.toFixed(0)}¬∞F (> ${max}¬∞F). 
      Could indicate over-charge or recirculation door fault.
    `;
  }
}

// re-run on either input change
document.getElementById("ambient").addEventListener("input", updateVentMessage);
document.getElementById("vent"   ).addEventListener("input", updateVentMessage);


    // ‚îÄ‚îÄ‚îÄ Diagnostic Bar Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDiagnosticBar(containerId, label, actualValue, targetMin, targetMax, unit = "", maxVisualRange = null, mode = "") {
      const container = document.getElementById(containerId);
      if (!container) return;
      const maxValue = maxVisualRange || targetMax * 1.5;
      const rangeWidthPct = ((targetMax - targetMin) / maxValue) * 100;
      const targetStartPct = (targetMin / maxValue) * 100;
      const valuePct = ((actualValue < 0 ? 0 : actualValue) / maxValue) * 100;
      const midpoint = (targetMin + targetMax) / 2;
      const deviation = (actualValue - midpoint).toFixed(0);
      const fillColor = (actualValue >= targetMin && actualValue <= targetMax)
        ? "#2ECC40"
        : actualValue < targetMin
        ? "#FFDC00"
        : "#FF4136";
      let warningNote = "";
      if (mode === "ir-shiny") {
        warningNote = `<div style="font-size: 0.8em; color: #888; margin-top:4px;">
          ‚ö†Ô∏è IR readings on shiny metal may underreport. Use black tape or contact probe for accuracy.
        </div>`;
      }
      container.innerHTML = `
        <div class="metric-label">
          ${label}: <strong>${actualValue}${unit}</strong><br>
          <span class="metric-range">
            (Target: ${targetMin}‚Äì${targetMax}${unit}, Œî: ${deviation}${unit})
          </span>
        </div>
        <div class="bar-wrapper">
          <div class="bar-track">
            <div class="bar-fill" style="width: ${Math.min(valuePct, 100)}%; background-color: ${fillColor};"></div>
            <div class="bar-target" style="left: ${targetStartPct}%; width: ${rangeWidthPct}%;"></div>
          </div>
        </div>
        ${warningNote}
      `;
    }

function updateDiagnosticBars(params) {
  const {
    ambient,
    rh,
    ventDelta,
    expectedVentRange,
    condRejectionDelta,
    refrigerant,
    superheat,
    subcooling,
    compressionRatio,
    highRatioThreshold,
    fillPercent,
    chargeDiff,
    chargeDiffUnit,
    chargeTolerance
  } = params;

  // 0) hide the standalone Charge Œî bar
  const chargeBar = document.getElementById("chargeDiffBar");
  if (chargeBar) chargeBar.style.display = "none";

  // 1) Vent ŒîT
  renderDiagnosticBar(
    "ventDeltaBar",
    "üå¨Ô∏è Vent ŒîT",
    Math.round(ventDelta),
    Math.round(expectedVentRange.min),
    Math.round(expectedVentRange.max),
    "¬∞F"
  );

  // 2) System Fill % + inline charge Œî
  const pct     = Math.round(fillPercent);                   // e.g. 98
  const devPct  = pct - 100;                                 // e.g. -2
  const ozDiff  = parseFloat(chargeDiff.toFixed(1));         // e.g. -1.6
  const unitLbl = chargeDiffUnit || document.getElementById("chargeUnit").value;

  // Draw the Fill % bar exactly as normal
  renderDiagnosticBar(
    "fillBar",
    "üß™ Estimated Fill %",
    pct,
    95,
    105,
    "%",
    110
  );

  // Then patch its ‚Äú(Target:‚Ä¶ Œî:‚Ä¶)‚Äù text
  const fillBarEl = document.getElementById("fillBar");
  const rangeEl   = fillBarEl.querySelector(".metric-range");
  if (rangeEl) {
    rangeEl.textContent =
      `(Target: 95‚Äì105%, Œî: ${devPct}% or ${ozDiff}${unitLbl})`;
  }

  // 3) Superheat
  renderDiagnosticBar(
    "superheatBar",
    "‚ùÑÔ∏è Superheat",
    Math.round(superheat),
    10,
    15,
    "¬∞F"
  );

  // 4) Subcooling
  renderDiagnosticBar(
    "subcoolingBar",
    "üßä Subcooling",
    Math.round(subcooling),
    5,
    refrigerant === "r1234yf" ? 18 : 20,
    "¬∞F"
  );

  // 5) Condenser Heat Rejection
  const condRange = getExpectedCondDelta(ambient, rh, document.getElementById("tempSource").value, refrigerant);
  renderDiagnosticBar(
    "condenserDeltaBar",
    "üî• Condenser Heat Rejection",
    Math.round(condRejectionDelta),
    Math.round(condRange.min),
    Math.round(condRange.max),
    "¬∞F",
    null,
    document.getElementById("tempSource").value
  );

  // 6) Compression Ratio
  renderDiagnosticBar(
    "compressionBar",
    "üìà Compression Ratio",
    Math.round(compressionRatio || 0),
    2.5,
    highRatioThreshold
  );
}

// ‚îÄ‚îÄ‚îÄ Generate Confidence Breakdown & Customer Summary Prompt Flags ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function generateConfidenceBreakdown(
      ambient,
      rh,
      ventDelta,
      expectedVentRange,
      subcooling,
      superheat,
      superheatStatus,
      superheatTag,
      condRejectionDelta,
      fillPercent,
      factoryCharge,
      isProperlyCharged,
      deductions,
      scorePct,
      confidenceEmoji,
      label,
      refrigerant = "r134a",
      mode = "ir-shiny",
      expansionDevice = "txv"
    ) {
      const condRange = getExpectedCondDelta(ambient, rh, mode, refrigerant);
      let subcoolMin, subcoolMax;
      if (refrigerant.toLowerCase() === "r1234yf") {
        if (expansionDevice === "orifice") { subcoolMin = 5; subcoolMax = 15; }
        else { subcoolMin = 8; subcoolMax = 18; }
      } else {
        if (expansionDevice === "orifice") { subcoolMin = 7; subcoolMax = 15; }
        else { subcoolMin = 10; subcoolMax = 20; }
      }

      let ventStatus;
      if (ventDelta < expectedVentRange.min) {
        ventStatus = `‚ùå Below expected range (Measured ŒîT: ${ventDelta.toFixed(0)}¬∞F). Tip: If Superheat is in range, suspect blend-door issues.`;
      } else if (ventDelta > expectedVentRange.max) {
        ventStatus = `‚ùå Above expected range (Measured ŒîT: ${ventDelta.toFixed(0)}¬∞F). Tip: If Superheat is in range and blower is MAX, suspect low airflow (dirty filter or mode fault).`;
      } else {
        ventStatus = `‚úÖ Within expected range (${expectedVentRange.min}‚Äì${expectedVentRange.max}¬∞F).`;
      }

      const issues = [];
      if (superheat < 10) {
        issues.push(`‚ùå Superheat too low (${superheat.toFixed(0)}¬∞F < 10¬∞F) ‚Äì TXV overfeeding suspected.`);
      } else if (superheat > 15) {
        issues.push(`‚ùå Superheat too high (${superheat.toFixed(0)}¬∞F > 15¬∞F) ‚Äì Undercharge or restriction suspected.`);
      }

      if (subcooling < subcoolMin) {
        issues.push(`‚ùå Subcooling too low (${subcooling.toFixed(0)}¬∞F < ${subcoolMin}¬∞F) ‚Äì Possible undercharge or poor condenser.`);
      } else if (subcooling > subcoolMax) {
        issues.push(`‚ùå Subcooling too high (${subcooling.toFixed(0)}¬∞F > ${subcoolMax}¬∞F) ‚Äì Possible overcharge.`);
      }

      if (condRejectionDelta < condRange.min) {
        issues.push(`‚ùå Heat Rejecion Diff is too low (${condRejectionDelta.toFixed(0)}¬∞F < ${condRange.min}¬∞F) ‚Äì Suspect low charge or restricted airflow.`);
      } else if (condRejectionDelta > condRange.max) {
        issues.push(`‚ùå CHeat Rejecion Diff is too high (${condRejectionDelta.toFixed(0)}¬∞F > ${condRange.max}¬∞F) ‚Äì Suspect overcharge or high airflow.`);
      }

      const fillStatus = (fillPercent >= 95 && fillPercent <= 105)
        ? "‚úÖ Ideal Fill (95‚Äì105%)"
        : `‚ùå Out of range (${fillPercent}%) ‚Äì Check charge.`;

      const fullBalanceStatus = issues.length === 0
        ? "‚úÖ System fully balanced ‚Äì All key values in spec."
        : `Tip: Address these issues ‚Üí\n‚Ä¢ ${issues.join("\n‚Ä¢ ")}`;

      const scoreDisplay = scorePct ? `${scorePct}%` : "‚ö†Ô∏è";
      const resultLabel = label || "Check values";
      
return `
  <div class="report-section">
    <strong>üîç Evaluation Summary:</strong><br>
    <strong>Score:</strong> ${scoreDisplay}<br>
    <strong>Result:</strong> ${confidenceEmoji} ${resultLabel}
  </div>

  <div class="report-section">
    üå¨Ô∏è Temp Drop at Vent: ${ventStatus}<br>
    üßä Evaporator's Temp Drop: ${
      subcooling < subcoolMin
        ? `‚ùå Low (${subcooling.toFixed(0)}¬∞F < ${subcoolMin}¬∞F)`
        : subcooling > subcoolMax
        ? `üî¥ High (${subcooling.toFixed(0)}¬∞F > ${subcoolMax}¬∞F)`
        : `‚úÖ Normal (${subcoolMin}‚Äì${subcoolMax}¬∞F)`
    }<br>
    ‚ùÑÔ∏è Condenser's Temp Drop: ${superheat.toFixed(0)}¬∞F ‚Äî ${superheatStatus}${superheatTag ? ` (${superheatTag})` : ""}<br>
    üî• Condenser's  Heat Rejection : ${
      condRejectionDelta < condRange.min
        ? `‚ùå Low (${condRejectionDelta.toFixed(0)}¬∞F < ${condRange.min}¬∞F)`
        : condRejectionDelta > condRange.max
        ? `üî¥ High (${condRejectionDelta.toFixed(0)}¬∞F > ${condRange.max}¬∞F)`
        : `‚úÖ Acceptable (${condRange.min}‚Äì${condRange.max}¬∞F)`
    }<br>
    üß™ ${refrigerant} Charge Fill: ${fillStatus}<br>
    üìä System Loop State: ${fullBalanceStatus}
  </div>

  <div id="tech-plan-section" class="report-section" style="border-left: 4px solid #0074D9; margin-top:12px; display:none;">
  <strong>üîß Technician Test Plan (Internal Use Only):</strong><br>
  <span id="tech-plan"></span>
</div>
`;



  const analysis = rootCause();   // 1) run your I-T-T-T logic
  document.getElementById("triageResults").textContent = analysis;  // 2) dump it into the DOM
}


// ‚îÄ‚îÄ‚îÄ Evaporator Load condition ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
	// ŒîT > 30¬∞F & proper charge & humidity high ‚áí heavy evaporator load	
function detectEvaporatorLoadHigh({ ambient, ventTemp, fillPercent, rh }) {
  	const ventDelta      = ambient - ventTemp;
  	const properlyCharged = fillPercent >= 95 && fillPercent <= 105;
  	return ventDelta > 30 && properlyCharged && rh > 60;
}

// ‚îÄ‚îÄ‚îÄ Unit conversion helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
	/**
 	* Convert a refrigerant quantity between oz, lb, and g.
 	* @param  {number} value    The quantity to convert.
 	* @param  {string} fromUnit 'oz' | 'lb' | 'g'
 	* @param  {string} toUnit   'oz' | 'lb' | 'g'
 	* @returns {number}
 	*/
function convertRefrigerant(value, fromUnit, toUnit) {
	let oz;
  	switch (fromUnit) {
    	case 'lb': oz = value * 16; break;
    	case 'g':  oz = value / 28.3495; break;
    	default:   oz = value;        break; // 'oz'
  }
  	switch (toUnit) {
    	case 'lb': return oz / 16;
    	case 'g':  return oz * 28.3495;
    	default:   return oz;         // 'oz'
  }
}

// ‚îÄ‚îÄ‚îÄ Calculate Charge difference ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calculateChargeDifference(factoryCharge, fillPercent, unit = 'oz') {
	const factoryOz = convertRefrigerant(factoryCharge, unit, 'oz');
	const actualOz  = (fillPercent / 100) * factoryOz;
	const diffOz    = actualOz - factoryOz;
	const diffUnit  = convertRefrigerant(diffOz, 'oz', unit);
	 return { diff: diffUnit, unit };   // ‚Üê this return is required!
}

</script>

<script>
// ‚îÄ‚îÄ Main Evaluation Logic: Precheck, Contamination, ITTT, Reporting ‚îÄ‚îÄ

function runEvaluation() {
  // 1) Require RO or Customer
  const roVal = document.getElementById("ro").value.trim();
  const customerVal = document.getElementById("customer").value.trim();
  if (!roVal && !customerVal) {
    ["ro", "customer"].forEach(flashField);
    alert("Please enter either RO# or Customer Name before proceeding.");
    return;
  }

  // 2) Require VIN or Vehicle
  const vinVal = document.getElementById("vin").value.trim();
  const vehicleVal = document.getElementById("vehicle").value.trim();
  if (!vinVal && !vehicleVal) {
    ["vin", "vehicle"].forEach(flashField);
    alert("Please enter either VIN or Year-Make-Model before proceeding.");
    return;
  }

  // 3) Require ZIP or Ambient
  const zipVal = document.getElementById("zipCode").value.trim();
  const ambientStr = document.getElementById("ambient").value.trim();
  if (!zipVal && !ambientStr) {
    ["zipCode", "ambient"].forEach(flashField);
    alert("Please enter either ZIP Code or Ambient Temperature before proceeding.");
    return;
  }

  // 4) Static Pressure
  if (!requireField("staticPressure", "Static Pressure (PSI)")) return;
  const refrigerantVal = document.getElementById("refrigerant").value;
  const ambientNum = parseFloat(ambientStr);
  const staticPSI = parseFloat(document.getElementById("staticPressure").value);
  const staticRange = getStaticPressureRange(ambientNum, refrigerantVal);
  if (staticPSI < staticRange.min) {
    if (!confirm(
      `Static PSI ${staticPSI} is below expected (${staticRange.min.toFixed(0)} psi).\n\nOK = Continue to dynamic testing.\nCancel = STOP and  recover/recharge to factory specs.`
    )) {
      document.getElementById("output").innerHTML = `
      <div class="report-section">
        <strong>‚ùå Undercharged System:</strong><br>
        Static PSI ${staticPSI} psi is below the ${staticRange.min.toFixed(0)} psi minimum.<br>
        Please recover & recharge to factory specs, then check for leaks before proceeding.
      </div>`;
      return;
    }
  }
  document.getElementById("advancedFieldsWrapper").style.display = "block";
  if (!requireField("factoryCharge", "Factory Charge (oz)")) return;

  // 5) High-Side Pressure
  if (!requireField("highPressure", "High-Side Pressure (PSI)")) return;

  // 6) Center Vent Temp
  if (!requireField("vent", "Center Vent Temp (¬∞F)")) return;

  // Gather dynamic inputs (no changes here)
  const ventTemp = parseFloat(document.getElementById("vent").value);
  const evapPressure = parseFloat(document.getElementById("evapPressure").value);
  const highPressure = parseFloat(document.getElementById("highPressure").value);
  const evapOutlet = parseFloat(document.getElementById("evapOutlet").value);
  const condOutlet = parseFloat(document.getElementById("outlet").value);
  const tempAtTXV = parseFloat(document.getElementById("tempAtTXV").value);
  let factoryCharge = parseFloat(document.getElementById("factoryCharge").value);

  const techNotes = document.getElementById("techNotes").value;
  const testStage = document.getElementById("testStage").value;
  const rh = parseFloat(document.getElementById("rh").value || 0);
  const compressorType = document.getElementById("compressorType").value;
  const pressureRelief = document.getElementById("pressureReliefConfirmed").value || "";
  const evapTempSrc = document.getElementById("evapTempSource").value;
  const chargedStatus = document.getElementById("chargedStatus").value;
  const tempSourceMode = document.getElementById("tempSource").value;

  // All your calculations here...

  // Derived calcs
  const evapSat = interpolate(ptTable[refrigerantVal], evapPressure);
  const condSat = interpolate(ptTable[refrigerantVal], highPressure);
  const subcoolingResult = getSubcoolingStatus(condSat, condOutlet, refrigerantVal);
  const subcooling = parseFloat(subcoolingResult.subcooling);
  const superheat = evapOutlet - evapSat;
  const condRejectionDelta = condSat - ambientNum;
  const ventDelta = ambientNum - ventTemp;
  const expectedVentRange = getExpectedVentDelta(ambientNum);
  const expectedCondSat = ambientNum + 25;
  const percentFillRaw = condSat / expectedCondSat;
  const fillPercent = Math.round(percentFillRaw * 100);
  const unit = document.getElementById("chargeUnit").value;
  const { diff: chargeDiff, unit: chargeUnit } =
      calculateChargeDifference(factoryCharge, fillPercent, unit);


const compressionRatio = evapPressure > 0 ? highPressure / evapPressure : null;
  const tpDeltaResult = evaluateTPDelta(ambientNum, condOutlet, tempAtTXV, tempSourceMode);
  const evapResult = evaluateEvapTempDifferential(evapSat, evapOutlet, evapTempSrc, rh);
  const isVDC = compressorType.toLowerCase().includes("vdc");
  const highRatioThreshold = isVDC
    ? (ambientNum >= 100 ? 5.2 : ambientNum >= 90 ? 4.8 : 4.5)
    : (ambientNum >= 100 ? 5.0 : ambientNum >= 90 ? 4.5 : 4.0);

  // Convert factoryCharge to ounces
  if (unit === "lb") {
    factoryCharge *= 16;
  } else if (unit === "g") {
    factoryCharge /= 28.3495;
  }

  const estimatedChargeOz = percentFillRaw * factoryCharge;
  let chargeDiffOz = estimatedChargeOz - factoryCharge;
  let chargeDiffDisplay = "";
  if (!isNaN(chargeDiffOz) && isFinite(chargeDiffOz) && factoryCharge > 0) {
    let displayVal, displayUnit;
    if (unit === "lb") {
      displayVal = (chargeDiffOz / 16).toFixed(2);
      displayUnit = "lb";
    } else if (unit === "g") {
      displayVal = (chargeDiffOz * 28.3495).toFixed(0);
      displayUnit = "g";
    } else {
      displayVal = chargeDiffOz.toFixed(2);
      displayUnit = "oz";
    }
    const direction = chargeDiffOz > 0 ? "Overcharged" : chargeDiffOz < 0 ? "Undercharged" : "At Spec";
    chargeDiffDisplay = `<br>üß™ <strong>Charge Difference:</strong> <span style="color: #0074D9;">
        ${Math.abs(displayVal)} ${displayUnit} ${direction}
      </span>`;
   }

// üìçconst { diff: chargeDiff, unit: chargeUnit } = calculateChargeDifference( factoryCharge,  fillPercent,   unit );

  const subLow = refrigerantVal === "r1234yf" ? 5 : 5;
  const subHigh = refrigerantVal === "r1234yf" ? 18 : 20;
  const isProperlyCharged =
    percentFillRaw >= 0.95 && percentFillRaw <= 1.05 &&
    superheat >= 10 && superheat <= 15 &&
    subcooling >= subLow && subcooling <= subHigh;

// üìçSuperheat status string FIX to check Vent air blockage 
  
let superheatStatus = "";
  if (superheat > 15) { superheatStatus = "‚ùå Superheat High (>15¬∞F) ‚Äì Restriction suspected.";
  } else if (superheat < 10) { superheatStatus = "‚ùå Superheat Low (<10¬∞F) ‚Äì TXV overfeeding suspected.";
  } else if (superheat >= 10 && superheat <= 15 && percentFillRaw >= 0.95 && percentFillRaw <= 1.05) { superheatStatus = "‚úÖ TXV working in range.";
  } else if (superheat >= 10 && superheat <= 15 && !isProperlyCharged) { if (isVDC) { superheatStatus = " Double check Evaporator Temp Sensor (ETS) performance for accuracy.";
  } else { superheatStatus = " Evaporator temp looks normal, but something else isn‚Äôt right. Check charge, airflow, and other performance issues.";
  }
}



  // ‚îÄ‚îÄ‚îÄ Confidence breakdown score ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let minCompression = compressorType && compressorType.toLowerCase().includes("vdc") ? 1.5 : 2.5;

const scorePct = Math.round([
  superheat >= 10 && superheat <= 15 ? 30 : 0,
  ventDelta >= expectedVentRange.min && ventDelta <= expectedVentRange.max ? 20 : 0,
  condRejectionDelta >= getExpectedCondDelta(ambientNum, rh, tempSourceMode, refrigerantVal).min &&
  condRejectionDelta <= getExpectedCondDelta(ambientNum, rh, tempSourceMode, refrigerantVal).max ? 20 : 0,
  compressionRatio >= minCompression && compressionRatio <= highRatioThreshold ? 15 : 0,
  fillPercent >= 95 && fillPercent <= 105 ? 10 : 0,
  isProperlyCharged ? 5 : 0,
  tpDeltaResult.scoreImpact > 0 ? 5 : 0
].reduce((a, b) => a + b, 0));

  let label = "";
  if (scorePct === 100) label = "Excellent Confidence";
  else if (scorePct >= 80) label = "Good Confidence";
  else if (scorePct >= 60) label = "Moderate Confidence";
  else label = "Low Confidence";

  let confidenceEmoji = "";
  if (scorePct === 100) confidenceEmoji = "‚úÖ";
  else if (scorePct >= 80) confidenceEmoji = "üëç";
  else if (scorePct >= 60) confidenceEmoji = "‚ö†Ô∏è";
  else confidenceEmoji = "‚ùå";

  // ‚îÄ‚îÄ‚îÄ Subcooling ŒîT note (TP#3‚ÜíTP#2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let subcoolingDeltaNote = "";
  if (!isNaN(condOutlet) && !isNaN(tempAtTXV)) {
    let delta = tempAtTXV - condOutlet + (tempSourceMode === "ir-shiny" ? 2 : 0);
    const absŒî = Math.abs(delta).toFixed(0);
    let noteLabel = "";
    if (document.getElementById("ihxEquipped").value === "yes") {
      if (delta < 0 && Math.abs(delta) <= 3) {
        noteLabel = `‚úÖ TP#3‚ÄìTP#2 ŒîT of ${delta.toFixed(0)}¬∞F confirms normal IHX behavior.<br><em>Expect a 1‚Äì3¬∞F drop when IHX is functioning correctly.</em>`;
      } else if (delta < -3) {
        noteLabel = `‚ö†Ô∏è Excessive TP#2 drop of ${absŒî}¬∞F on IHX system ‚Äì verify routing, insulation, or sensor placement.`;
      } else if (delta >= 0 && delta <= 3) {
        noteLabel = `‚ö†Ô∏è Unexpected TP#2 rise of ${delta.toFixed(0)}¬∞F ‚Äì IHX may not be functioning properly.`;
      } else {
        noteLabel = `‚ö†Ô∏è Unusual TP#3‚ÄìTP#2 ŒîT of ${delta.toFixed(0)}¬∞F ‚Äì investigate IHX routing or refrigerant imbalance.`;
      }
    } else {
      if (Math.abs(delta) <= 2) {
        noteLabel = `‚úÖ ŒîT within ¬±2¬∞F (Œî = ${delta.toFixed(0)}¬∞F) ‚Äì routing OK, minimal ambient gain.`;
      } else if (delta > 2) {
        noteLabel = `‚ö†Ô∏è TP#3‚ÜíTP#2 rise of ${delta.toFixed(0)}¬∞F ‚Äì unexpected heat pickup. Check routing or hot-engine proximity.`;
      } else {
        noteLabel = `‚ö†Ô∏è TP#3‚ÜíTP#2 drop of ${absŒî}¬∞F ‚Äì unexpected cooling. Verify sensor accuracy and insulation.`;
      }
    }
    subcoolingDeltaNote = `
      <div class="report-section">
        <strong>üßä TP#3‚ÄìTP#2 Subcooling Integrity:</strong><br>
        Condenser Outlet: ${condOutlet.toFixed(0)}¬∞F<br>
        TXV Inlet: ${tempAtTXV.toFixed(0)}¬∞F<br>
        ŒîT: ${delta.toFixed(0)}¬∞F<br>
        ${noteLabel}
      </div>`;
  }

  // ‚îÄ‚îÄ‚îÄ Relief Valve note if flagged & factory charge OK ‚îÄ‚îÄ
  let reliefValveNote = "";
  const factoryChargeOK = chargedStatus === "charged" && fillPercent >= 98 && fillPercent <= 102;
  if (pressureRelief === "yes" && factoryChargeOK) {
    reliefValveNote = `
      <div class="report-section" style="border-left: 4px solid red;">
        <strong>üí• Relief Valve Discharge Event Detected</strong><br>
        System was properly charged, indicating likely upstream restriction or overpressure event.
      </div>`;
  }

  // ‚îÄ‚îÄ‚îÄ Pressure Relief Section (if charged) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let pressureReliefSection = "";
  if (chargedStatus === "charged") {
    if (pressureRelief === "yes") {
      pressureReliefSection = `
        <div class="report-section" style="border-left: 4px solid red;">
          <strong>üí• Pressure Relief Event Detected</strong><br>
          Technician confirmed a relief hiss after startup.<br>
          üö® <strong>Dynamic A/C testing halted!</strong><br>
          Suspected upstream blockage near condenser inlet.
        </div>`;
    } else if (pressureRelief === "no") {
      pressureReliefSection = `
        <div class="report-section">
          <strong>üßØ Pressure Relief Observation:</strong><br>
          Technician confirmed <strong>no audible relief</strong> after startup.
        </div>`;
    } else {
      pressureReliefSection = `
        <div class="report-section" style="border-left: 4px solid #FF851B;">
          <h3>üí• Pressure Relief Observation Prompt</h3>
          <p><strong>Action Required:</strong> Start vehicle, set A/C to MAX, monitor high-side gauge and listen for hissing.</p>
          <p>Was a relief hiss heard?</p>
          <div style="display: flex; gap: 10px; justify-content: space-between; margin-top: 10px;">
            <button onclick="handleLiquidPortReliefResponse(true)">‚úÖ No Relief Heard</button>
            <button onclick="handleLiquidPortReliefResponse(false)">‚ùå Relief Heard</button>
          </div>
        </div>`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ Build final report HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const brandingContent = document.getElementById("brandingHeader").innerHTML;
  const customer = document.getElementById("customer").value || "N/A";
  const vehicle = document.getElementById("vehicle").value || "N/A";
  const ro = document.getElementById("ro").value || "N/A";
  const timeNow = new Date().toLocaleString();

  document.getElementById("timestamp").innerText = `Testing Timestamp: ${timeNow}`;
  document.getElementById("output").innerHTML = `
    <div style="text-align:center; margin-bottom: 20px;">${brandingContent}</div>
    <div class="report-section">
      <strong>RO#:</strong> ${ro}<br>
      <strong>Customer:</strong> ${customer}<br>
      <strong>Vehicle:</strong> ${vehicle}<br>
      <strong>ZIP:</strong> ${zipVal || "N/A"}<br>
      <strong>Time:</strong> ${timeNow}<br>
      <strong>Evaluation Test Stage:</strong> ${testStage}<br>
      ${window.fetchedWeather ? `Weather: ${window.fetchedWeather.ambient}¬∞F, RH: ${window.fetchedWeather.rh}%<br>` : ""}
    </div>

    <div class="report-section">
      <strong>ü´ß Static Pressure Analysis:</strong><br>
      Ambient: ${ambientNum}¬∞F<br>
      Measured Static PSI: ${staticPSI} psi<br>
      Expected Range: ${staticRange.min.toFixed(0)}‚Äì${staticRange.max.toFixed(0)} psi (${refrigerantVal.toUpperCase()})<br>
      Status: ${
        staticPSI < staticRange.min    ? "‚ö†Ô∏è Below Range ‚Äì Undercharged" :
        staticPSI > staticRange.max + 10 ? "üî¥ Significantly Above ‚Äì Possible contamination" :
        staticPSI > staticRange.max    ? "‚ö†Ô∏è Slightly High ‚Äì Monitor"
        : "‚úÖ Within Range"
      }
    </div>

    ${pressureReliefSection}
    ${subcoolingDeltaNote}
    ${reliefValveNote}

    ${generateConfidenceBreakdown(
      ambientNum,
      rh,
      ventDelta,
      expectedVentRange,
      subcooling,
      Math.round(superheat),
      superheatStatus,
      "",
      condRejectionDelta,
      fillPercent,
      factoryCharge,
      isProperlyCharged,
      [],
      scorePct,
      confidenceEmoji,
      label,
      refrigerantVal,
      tempSourceMode,
      document.getElementById("expansionDevice").value
    )}

<div class="metric-grid">

  <!-- üå¨Ô∏è Vent ŒîT -->
  <div class="tooltip">
    <div id="ventDeltaBar" class="metric-bar"></div>
    <div class="tooltip-content">
      <strong>Vent ŒîT (Air Cooling Drop)</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li><strong>Too Small:</strong> Vent isn‚Äôt cold enough ‚Äì likely poor airflow (dirty filter or wrong vent door).</li>
        <li><strong>Just Right:</strong> Airflow and heat removal are on point.</li>
        <li><strong>Too Big:</strong> Could be overcharged or recirculation-door stuck.</li>
      </ul>
      <strong>Quick Tips & Pitfalls</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li>Always run blower on MAX when measuring.</li>
        <li>Double-check fresh-air vs recirc mode.</li>
        <li>Let it run 2‚Äì3 minutes under full load before reading.</li>
      </ul>
    </div>
  </div>

  <!-- üî• Condenser ŒîT -->
  <div class="tooltip">
    <div id="condenserDeltaBar" class="metric-bar"></div>
    <div class="tooltip-content">
      <strong>Condenser ŒîT (Condenser Cooling Drop)</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li><strong>Too Small:</strong> Low refrigerant or blocked condenser airflow.</li>
        <li><strong>Just Right:</strong> Condenser dumping heat correctly.</li>
        <li><strong>Too Big:</strong> Overcharged or fans blowing too hard.</li>
      </ul>
      <strong>Quick Tips & Pitfalls</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li>If ambient is low, measure right after fan kicks on.</li>
        <li>Keep hoses and gauges away from engine heat soak.</li>
      </ul>
    </div>
  </div>

  <!-- üìà Compression Ratio -->
  <div class="tooltip">
    <div id="compressionBar" class="metric-bar"></div>
    <div class="tooltip-content">
      <strong>Compression Ratio</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li><strong>Below 2.5:</strong> Undercharge or slipping compressor.</li>
        <li><strong>2.5‚Äì4.5:</strong> Healthy compression.</li>
        <li><strong>Above 4.5:</strong> Possible overcharge or restriction.</li>
      </ul>
      <strong>Quick Tips & Pitfalls</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li>Read pressures with engine running, A/C on MAX.</li>
        <li>Ignore static (cold-start) pressures‚Äîthey‚Äôre misleading.</li>
      </ul>
    </div>
  </div>

  <!-- üß™ Estimated Fill % -->
  <div class="tooltip">
    <div id="fillBar" class="metric-bar"></div>
    <div class="tooltip-content">
      <strong>Estimated Fill %</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li><strong>&lt;95%:</strong> Undercharged ‚Äî add refrigerant.</li>
        <li><strong>95‚Äì105%:</strong> Correct factory charge.</li>
        <li><strong>&gt;105%:</strong> Overcharged ‚Äî recover refrigerant.</li>
      </ul>
      <strong>Quick Tips & Pitfalls</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li>Verify factory-charge spec for that vehicle.</li>
        <li>Convert units (oz‚áÑlb‚áÑg) before calculating.</li>
        <li>Let pressures stabilize (~2 min) under full load.</li>
      </ul>
    </div>
  </div>

  <!-- ‚ùÑÔ∏è Superheat -->
  <div class="tooltip">
    <div id="superheatBar" class="metric-bar"></div>
    <div class="tooltip-content">
      <strong>Superheat</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li><strong>&lt;10 ¬∞F:</strong> Too little‚ÄîTXV overfeeding or too-large orifice.</li>
        <li><strong>10‚Äì15 ¬∞F:</strong> Balanced evaporator load.</li>
        <li><strong>&gt;15 ¬∞F:</strong> Undercharge or restriction suspected.</li>
      </ul>
      <strong>Quick Tips & Pitfalls</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li>Measure at the same spot on suction line each time.</li>
        <li>Use black-tape or a probe‚Äîdon‚Äôt trust shiny-metal IR readings.</li>
        <li>Humidity can skew readings‚Äîkeep it in mind.</li>
      </ul>
    </div>
  </div>

  <!-- üßä Subcooling (you already have this) -->
  <div class="tooltip">
    <div id="subcoolingBar" class="metric-bar"></div>
    <div class="tooltip-content">
      <strong>Subcooling</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li><strong>&lt;5 ¬∞F:</strong> Undercharged or poor condenser airflow.</li>
        <li><strong>8‚Äì20 ¬∞F:</strong> Correct charge & good heat rejection.</li>
        <li><strong>&gt;20 ¬∞F:</strong> Overcharge or bypass condition.</li>
      </ul>
      <strong>Quick Tips & Pitfalls</strong>
      <ul style="margin:4px 0 4px 16px;">
        <li>Let the system stabilize under load before reading.</li>
        <li>If fans cycle off, read immediately when they restart.</li>
        <li>TXV systems: 10‚Äì15 ¬∞F; orifice systems: 12‚Äì20 ¬∞F target.</li>
      </ul>
    </div>
  </div>

</div>

  </div>
    ${techNotes ? `<div class="report-section"><strong>Technician Notes:</strong><br>${techNotes.replace(/\n/g, "<br>")}</div>` : ""}
    ${attachedImages.map(src => `<img src="${src}" style="max-width:150px; margin-top:10px;" />`).join("")}
  `;

  // ‚îÄ‚îÄ‚îÄ Update diagnostic bars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  updateDiagnosticBars({
    	ambient: ambientNum, rh,
    	ventDelta, expectedVentRange,
    	condRejectionDelta,
    	refrigerant: refrigerantVal,    
    	superheat, subcooling,
    	compressionRatio, highRatioThreshold,
	fillPercent, 
	chargeDiff, 
	chargeDiffUnit: 
	chargeUnit,  
	chargeTolerance: 2
});
// At the end of runEvaluation (before modals/advisory blocks)
// Build your POST payload for backend API:
  let vehicleYear = vehicleVal;
  if (typeof vehicleVal === "string") {
    const yearMatch = vehicleVal.match(/\d{4}/);
    vehicleYear = yearMatch ? parseInt(yearMatch[0], 10) : 0;
  }

  const postPayload = {
    year: vehicleYear || "",
    make: vehicleVal.split(' ')[1] || "",
    model: vehicleVal.split(' ')[2] || "",
    vehicle: vehicleVal,
    customer: customerVal,
    superheat: evapOutlet - interpolate(ptTable[refrigerantVal], evapPressure),
    subcooling: parseFloat(getSubcoolingStatus(interpolate(ptTable[refrigerantVal], highPressure), condOutlet, refrigerantVal).subcooling),
    fillPercent: Math.round((interpolate(ptTable[refrigerantVal], highPressure) / (ambientNum + 25)) * 100),
    ambient: ambientNum,
    ventTemp: ventTemp,
    rh: rh,
    highPressure: highPressure,
    lowPressure: evapPressure,
    compressorType: compressorType,
    expansionDevice: document.getElementById("expansionDevice").value,
    dtcList: [], // Add real DTCs if you have them
    // ...add more if needed
  };

  // Backend API call for summary and tech plan
  fetch('/api/index.ts', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(postPayload)
  })
  .then(response => response.json())
  .then(data => {
    // Customer summary
    document.getElementById("customerSummary").textContent = data.reply || "";

    // Technician/internal test plan
    if (data.testPlan) {
      document.getElementById('tech-plan').textContent = data.testPlan;
      document.getElementById('tech-plan-section').style.display = "block";
    } else {
      document.getElementById('tech-plan-section').style.display = "none";
    }

    // Tooltip handlers (set after HTML is updated)
    document.querySelectorAll('.tooltip').forEach(wrapper => {
      wrapper.addEventListener('click', () => {
        wrapper.classList.toggle('show');
      });
    });

    // (Optional) Update other state
    window.latestReportText = stripHTML(document.getElementById("output").innerHTML);

    // (Optional) Service interval advisory
    const serviceInterval = document.getElementById("serviceInterval").value;
    if (serviceInterval === "Never") {
      // ...your advisory logic here, unchanged...
    }
  })
  .catch(err => {
    document.getElementById("customerSummary").textContent =
      "There was a problem processing your request. Please try again.";
  });
}

// Attach the event listener
document.getElementById("evaluateBtn").addEventListener("click", runEvaluation);

</script>

<script>
//‚îÄ‚îÄ‚îÄ DOWNLOAD PDF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>
async function downloadPDF() {
  const reportEl = document.getElementById("output");
  if (!reportEl || !reportEl.innerHTML.trim()) {
    alert("Please run Dynamic Testing first before saving to PDF.");
    return;
  }

  const downloadBtn = document.getElementById("downloadBtn");
  if (downloadBtn) {
    downloadBtn.disabled = true;
    downloadBtn.innerText = "Generating PDF‚Ä¶";
  }

  // append owner message
    if (ownerMsgEl && ownerMsgEl.textContent.trim()) {
    reportEl.insertAdjacentHTML(
      "beforeend",
      `<div class="report-section">${ownerMsgEl.innerHTML}</div>`
    );
  }

  // wait for images
  const images = reportEl.querySelectorAll("img");
  await Promise.all(Array.from(images).map(img => {
    if (img.complete) return Promise.resolve();
    return new Promise(resolve => { img.onload = img.onerror = resolve; });
  }));

  // render to canvas
  const canvas = await html2canvas(reportEl, {
    scale: 2,
    useCORS: true,
    allowTaint: true,
    scrollY: 0
  });
  const imgData = canvas.toDataURL("image/png");

  // build PDF
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "pt", "letter");
  const pageWidth  = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgWidth   = canvas.width;
  const imgHeight  = canvas.height;
  const ratio      = Math.min(pageWidth / imgWidth, pageHeight / imgHeight);
  const imgW       = imgWidth * ratio;
  const imgH       = imgHeight * ratio;
  const marginX    = (pageWidth  - imgW) / 2;
  const marginY    = (pageHeight - imgH) / 2;

  pdf.addImage(imgData, "PNG", marginX, marginY, imgW, imgH);

  // filename
  const timeStamp = new Date().toISOString().slice(0, 10);
  const vehicle   = (document.getElementById("vehicle").value || "Vehicle").replace(/[^\w\-]/g, "_");
  const ro        = (document.getElementById("ro").value || "").replace(/[^\w\-]/g, "_");
  const evalType  = (document.getElementById("testStage").value || "Evaluation").replace(/[^\w\-]/g, "_");
  const filename  = `RO${ro}_${vehicle}_AC-Triage_${evalType}_${timeStamp}.pdf`;

  pdf.save(filename);

  if (downloadBtn) {
    downloadBtn.disabled = false;
    downloadBtn.innerText = "Save as PDF";
  }
}
</script>

<script>
// --- Modal helpers ---
function showModal(id) {
  const modal = document.getElementById(id);
  if (modal) modal.style.display = "flex";
}
function hideModal(id) {
  const modal = document.getElementById(id);
  if (modal) modal.style.display = "none";
}

// --- Tech Name Display and Modal Logic ---
function updateTechNameDisplay() {
  const techName = window.techName && window.techName.trim();
  const display = document.getElementById("reportTechName");
  if (display) {
    if (techName) {
      display.textContent = `Report prepared by ${techName}`;
    } else {
      display.textContent = "";
      // Show confirmation if tech name missing and modal not already open
      if (!window.confirmationModalShown) {
        resetConfirmationModal();
        showModal("confirmationModal");
        window.confirmationModalShown = true;
      }
    }
  }
}

function resetConfirmationModal() {
  window.confirmationModalShown = false;
  window.techName = "";
  const techNameInput = document.getElementById("techNameInput");
  const continueBtn = document.getElementById("confirmationContinueBtn");
  if (techNameInput) techNameInput.value = "";
  if (continueBtn) continueBtn.disabled = true;
  hideModal("confirmationModal");
}

// --- AUTOSAVE/RESTORE for A/C Triage Pro ---
const AUTOSAVE_FIELDS = [
  "ro", "customer", "vin", "vehicle", "zipCode", "ambient", "rh",
  "staticPressure", "serviceInterval", "testStage", "refrigerant",
  "factoryCharge", "chargeUnit", "tempSource", "highSidePortType",
  "expansionDevice", "evapTempSource", "ihxEquipped", "compressorType",
  "evapPressure", "evapOutlet", "highPressure", "outlet", "tempAtTXV",
  "vent", "techNotes"
];

const CLEAR_FIELDS = [
  "techName","ro", "customer", "vin", "vehicle", "zipCode", "ambient", "rh", 
  "staticPressure", "factoryCharge", "evapPressure", "evapOutlet", 
  "highPressure", "outlet", "tempAtTXV", "vent", "techNotes"
];

const RESET_TO_DEFAULT_FIELDS = [
  "serviceInterval", "testStage", "refrigerant", "chargeUnit", "tempSource",
  "highSidePortType", "expansionDevice", "evapTempSource", "ihxEquipped", "compressorType"
];

// 1. Save all fields on any change
function autosaveForm() {
  const data = {};
  AUTOSAVE_FIELDS.forEach(id => {
    const el = document.getElementById(id);
    if (el) data[id] = el.value;
  });
  localStorage.setItem("acTriageFormData", JSON.stringify(data));
}

// 2. Restore all fields on page load
function restoreForm() {
  const data = JSON.parse(localStorage.getItem("acTriageFormData") || "{}");
  AUTOSAVE_FIELDS.forEach(id => {
    const el = document.getElementById(id);
    if (el && data[id] !== undefined && data[id] !== null && data[id] !== "") {
      el.value = data[id];
    }
  });
  if (typeof evaluateStaticPressure === "function") evaluateStaticPressure();
  if (typeof updateVentMessage === "function") updateVentMessage();
}

// 3. Clear everything for a new report (MUST BE OUTSIDE DOMContentLoaded!)
function clearAutosave() {
  // 1. Remove autosaved data
  localStorage.removeItem("acTriageFormData");

  // 2. Clear all simple input fields
  CLEAR_FIELDS.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  // 3. Reset all select dropdowns to their default options
  RESET_TO_DEFAULT_FIELDS.forEach(id => {
    const el = document.getElementById(id);
    if (el && el.options && el.options.length) {
      let selectedIndex = 0;
      for (let i = 0; i < el.options.length; i++) {
        if (el.options[i].defaultSelected) {
          selectedIndex = i;
          break;
        }
      }
      el.selectedIndex = selectedIndex;
    }
  });

  // 4. Hide advanced fields
  const adv = document.getElementById("advancedFieldsWrapper");
  if (adv) adv.style.display = "none";

  // 5. Reset technician name and modal
  window.techName = "";
  localStorage.removeItem("acTriageTechName");
  updateTechNameDisplay();

  // --- OPTIONAL ENHANCEMENTS BELOW ---
  const preview = document.getElementById("photoPreview");
  if (preview) preview.innerHTML = "";
  if (typeof attachedImages !== "undefined") attachedImages = [];

  const out = document.getElementById("output");
  if (out) out.innerHTML = "";
  if (custSummary) custSummary.textContent = "";

  const cwDiv = document.getElementById("cw_messages");
  if (cwDiv) cwDiv.innerHTML = "";

  window.scrollTo({ top: 0, behavior: "smooth" });
}

// --- DOMContentLoaded (SETUP) ---
document.addEventListener("DOMContentLoaded", function() {
  window.confirmationModalShown = false;
  // Restore techName from localStorage if present
  window.techName = localStorage.getItem("acTriageTechName") || "";

  AUTOSAVE_FIELDS.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("input", autosaveForm);
  });

  restoreForm();
  updateTechNameDisplay();

  setTimeout(() => {
    // Only show modal if no techName found in storage
    if (!window.techName || window.techName.trim() === "") {
      resetConfirmationModal();
      showModal("confirmationModal");
      window.confirmationModalShown = true;
    }
  }, 100);
});

// --- Modal capture on confirmation ---
document.addEventListener("DOMContentLoaded", function() {
  const techNameInput = document.getElementById("techNameInput");
  const continueBtn = document.getElementById("confirmationContinueBtn");
  if (techNameInput && continueBtn) {
    techNameInput.addEventListener("input", function() {
      continueBtn.disabled = (this.value.trim() === "");
    });
    continueBtn.addEventListener("click", function() {
      window.techName = techNameInput.value.trim();
	localStorage.setItem("acTriageTechName", window.techName);      
	hideModal("confirmationModal");
      updateTechNameDisplay();
    });
  }
});
</script>

<button onclick="clearAutosave()">Start New Report</button>


</body>
</html>
